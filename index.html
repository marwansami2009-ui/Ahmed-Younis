<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª | Ø£/ Ø£Ø­Ù…Ø¯ Ø³Ø¹Ø¯ ÙŠÙˆÙ†Ø³</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, child, push, update, onValue, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWvMBrjkjU02jfOe8HKNnDHNx1ZshlDdo",
            authDomain: "el-alamy-platform.firebaseapp.com",
            projectId: "el-alamy-platform",
            storageBucket: "el-alamy-platform.firebasestorage.app",
            messagingSenderId: "790950981758",
            appId: "1:790950981758:web:21cf7c65e9d2cce210a82f",
            measurementId: "G-970BP0VKQQ",
            databaseURL: "https://el-alamy-platform-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app); 
        window.auth = getAuth(app);
        window.googleProvider = new GoogleAuthProvider();
        window.rtdb = { ref, set, get, child, push, update, onValue, remove, serverTimestamp };
        window.authMethods = { signInWithPopup, signOut, onAuthStateChanged };
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        brand: {
                            dark: '#0f172a',
                            card: '#1e293b',
                            primary: '#3b82f6',
                            accent: '#fbbf24',
                            gold: '#FFD700',
                            silver: '#C0C0C0',
                            bronze: '#CD7F32',
                            success: '#10b981',
                            warning: '#f59e0b',
                            danger: '#ef4444'
                        }
                    },
                    fontFamily: { 'cairo': ['Cairo', 'sans-serif'] },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.8s ease-out',
                        'pulse-glow': 'pulseGlow 2s ease-in-out infinite',
                        'bounce-slow': 'bounceSlow 3s infinite'
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-20px)' } },
                        slideUp: { '0%': { transform: 'translateY(30px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        pulseGlow: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.7' } },
                        bounceSlow: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        
        * { box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background-color: #0f172a; color: white; overflow-x: hidden; margin: 0; }
        
        .glass-panel { 
            background: rgba(30, 41, 59, 0.85); 
            backdrop-filter: blur(16px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            border-radius: 16px;
        }

        .btn-main {
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            color: #0f172a;
            font-weight: 800;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
        }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(251, 191, 36, 0.5); }
        
        .embed-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .embed-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        
        .math-grid {
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        
        .hero-glow {
            background: radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.15) 0%, transparent 50%);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #fbbf24; }

        .quiz-option {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .quiz-option:hover {
            transform: translateX(-5px);
            border-color: #fbbf24;
        }
        .quiz-option.selected {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
        }

        .rank-gold { background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.05)); border: 1px solid rgba(255, 215, 0, 0.3); }
        .rank-silver { background: linear-gradient(135deg, rgba(192, 192, 192, 0.2), rgba(192, 192, 192, 0.05)); border: 1px solid rgba(192, 192, 192, 0.3); }
        .rank-bronze { background: linear-gradient(135deg, rgba(205, 127, 50, 0.2), rgba(205, 127, 50, 0.05)); border: 1px solid rgba(205, 127, 50, 0.3); }
        
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid #fbbf24;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .attendance-btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .attendance-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(251, 191, 36, 0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .attendance-btn:hover::after {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // ğŸ” Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø£Ø¯Ù…Ù†
        const VALID_CODES = { 
            'BOSS-MATH-2025': 'boss',
            'ADMIN-001': 'admin',
            'ADMIN-002': 'admin',
            'ADMIN-003': 'admin',
            'ADMIN-004': 'admin',
            'ADMIN-005': 'admin',
            'ADMIN-006': 'admin',
            'ADMIN-007': 'admin',
            'ADMIN-008': 'admin',
            'ADMIN-009': 'admin',
            'ADMIN-010': 'admin'
        };

        // ğŸ“± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„
        const CONTACT_INFO = {
            whatsapp: 'https://wa.me/201000000000',
            facebook: 'https://facebook.com/yourpage',
            youtube: 'https://youtube.com/yourchannel',
            telegram: 'https://t.me/yourchannel',
            vodafoneNumber: '010xxxxxxxx',
            supportWhatsapp: 'https://wa.me/201000000000',
            masterWhatsapp: 'https://wa.me/201111111111' // Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ± Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª
        };

        // ğŸ“Š Ø£Ù†Ø¸Ù…Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ù„Ø±ØªØ¨
        const RANK_SYSTEM = {
            attendance: [
                { level: 1, name: 'Ù…Ø¨ØªØ¯Ø¦', min: 0, color: '#6b7280' },
                { level: 2, name: 'Ù…Ù†ØªØ¸Ù…', min: 10, color: '#3b82f6' },
                { level: 3, name: 'Ù…Ù„ØªØ²Ù…', min: 30, color: '#8b5cf6' },
                { level: 4, name: 'Ù…ØªÙÙˆÙ‚', min: 60, color: '#10b981' },
                { level: 5, name: 'Ø¨Ø·Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±', min: 100, color: '#fbbf24' }
            ],
            performance: [
                { level: 1, name: 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†', min: 0, color: '#6b7280' },
                { level: 2, name: 'Ù…Ù‚Ø¨ÙˆÙ„', min: 60, color: '#3b82f6' },
                { level: 3, name: 'Ø¬ÙŠØ¯', min: 75, color: '#10b981' },
                { level: 4, name: 'Ù…ØªÙ…ÙŠØ²', min: 85, color: '#8b5cf6' },
                { level: 5, name: 'Ø¹Ø¨Ù‚Ø±ÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', min: 95, color: '#fbbf24' }
            ]
        };

   // ğŸ›¡ï¸ SafeIcon Component - Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø¬Ù…ÙŠÙ„Ø©
const SafeIcon = ({ name, size = 20, className = '' }) => {
    const icons = {
        'home': 'ğŸ ', 'video': 'ğŸ¬', 'play-circle': 'â–¶ï¸', 'credit-card': 'ğŸ’³',
        'help-circle': 'â“', 'gift': 'ğŸ', 'trending-up': 'ğŸ“ˆ', 'calendar-check': 'ğŸ“…',
        'bell': 'ğŸ””', 'message-circle': 'ğŸ’¬', 'calculator': 'ğŸ§®', 'user': 'ğŸ‘¤',
        'key': 'ğŸ”‘', 'clock': 'â°', 'send': 'ğŸ“¤', 'log-in': 'â†ªï¸', 'menu': 'â˜°',
        'x': 'âœ–ï¸', 'check': 'âœ“', 'check-circle': 'âœ…', 'alert-circle': 'âš ï¸',
        'trash-2': 'ğŸ—‘ï¸', 'arrow-right': 'â†’', 'arrow-left': 'â†', 'lock': 'ğŸ”’',
        'unlock': 'ğŸ”“', 'star': 'â­', 'lightbulb': 'ğŸ’¡', 'mail': 'âœ‰ï¸',
        'phone': 'ğŸ“', 'book-open': 'ğŸ“–', 'file-text': 'ğŸ“„', 'image': 'ğŸ–¼ï¸',
        'headphones': 'ğŸ§', 'settings': 'âš™ï¸', 'facebook': 'f', 'youtube': 'â–¶',
        'instagram': 'ğŸ“·'
    };
    
    const emoji = icons[name] || 'ğŸ”¹';
    
    return (
        <span 
            style={{ 
                fontSize: `${size * 0.7}px`,
                display: 'inline-block',
                width: `${size}px`,
                height: `${size}px`,
                lineHeight: 1
            }}
            className={className}
        >
            {emoji}
        </span>
    );
};

        // ğŸ›¡ï¸ Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            
            componentDidCatch(error, errorInfo) {
                console.error('App Error:', error, errorInfo);
            }
            
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-brand-dark flex items-center justify-center p-4">
                            <div className="glass-panel p-8 text-center">
                                <div className="text-6xl mb-4">âš ï¸</div>
                                <h2 className="text-2xl font-bold text-red-400 mb-2">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h2>
                                <p className="text-slate-400 mb-4">Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...</p>
                                <button 
                                    onClick={() => window.location.reload()}
                                    className="btn-main px-6 py-3 rounded-xl"
                                >
                                    Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // ğŸ¯ WhatsApp Message Sender
        const sendWhatsAppToAll = () => {
            const message = prompt("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨:");
            if (!message) return;
            
            // Ù‡Ø°Ø§ Ù…Ø«Ø§Ù„ Ù„Ø±Ø³Ø§Ù„Ø© Ø¬Ù…Ø§Ø¹ÙŠØ© - ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø³ØªØ­ØªØ§Ø¬ Ù„Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„ Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù‰ Ø­Ø¯Ø©
            const baseUrl = "https://wa.me/?text=";
            const encodedMessage = encodeURIComponent(message);
            window.open(`${baseUrl}${encodedMessage}`, '_blank');
        };

        const App = () => {
            // --- State Management ---
            const [user, setUser] = useState(null); 
            const [view, setView] = useState('loading'); 
            const [dataState, setDataState] = useState({ 
                students: [], requests: [], lectures: [], whiteboards: [], 
                qa: [], exams: [], announcements: [], payments: [], subscriptions: {},
                freeContent: [], attendance: {}, performance: {}, weeklyAssessments: {}
            });
            
            // Registration Data - Ù…Ø­Ø¯Ø«
            const [regData, setRegData] = useState({ 
                firstName: '',
                secondName: '',
                thirdName: '',
                phone: '', 
                parentPhone: '', 
                school: '',
                governorate: '', 
                city: '',
                center: '', // Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø¬Ø¯ÙŠØ¯
                grade: '1sec',
                address: '',
                scheduleDays: 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ† ÙˆØ§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡' // Ø£ÙŠØ§Ù… Ø§Ù„Ø­ØµØµ
            });
            
            const [loginCode, setLoginCode] = useState('');
            const [studentLoginCode, setStudentLoginCode] = useState('');
            
            // UI States
            const [activeTab, setActiveTab] = useState('home');
            const [selectedLecture, setSelectedLecture] = useState(null);
            const [currentLectureStep, setCurrentLectureStep] = useState('video');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [notification, setNotification] = useState(null);
            const [showStudentModal, setShowStudentModal] = useState(false);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [showFreeContent, setShowFreeContent] = useState(false);
            const [activeGrade, setActiveGrade] = useState('all');
            const [showAssessmentModal, setShowAssessmentModal] = useState(false);
            const [isGuestMode, setIsGuestMode] = useState(false);
            
            // Quiz State
            const [quizAnswers, setQuizAnswers] = useState({});
            const [quizSubmitted, setQuizSubmitted] = useState(false);

            // Attendance State
            const [attendanceChecked, setAttendanceChecked] = useState(false);

            const showNotification = (message, type = 'success') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 4000);
            };

            // --- Generate Student Code ---
            const generateStudentCode = () => {
                const prefix = 'ALAMY';
                const random = Math.random().toString(36).substr(2, 8).toUpperCase();
                return `${prefix}-${random}`;
            };

            // --- Calculate Rank ---
            const calculateRank = (type, value) => {
                const ranks = RANK_SYSTEM[type];
                for (let i = ranks.length - 1; i >= 0; i--) {
                    if (value >= ranks[i].min) {
                        return ranks[i];
                    }
                }
                return ranks[0];
            };

            // --- WhatsApp Message Generator ---
            const generateWelcomeMessage = (studentName, studentCode, phone) => {
                return `ğŸ‰ *Ù…Ø¨Ø±ÙˆÙƒ Ù‚Ø¨ÙˆÙ„Ùƒ ÙÙŠ Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª!*\n\nğŸ‘¤ *Ø§Ù„Ø·Ø§Ù„Ø¨:* ${studentName}\nğŸ”‘ *ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„:* ${studentCode}\nğŸ“± *Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:* ${phone}\n\nğŸ“š *Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„:*\n1. Ø§Ø¯Ø®Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹: https://el-alamy.com\n2. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨"\n3. Ø§Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯: ${studentCode}\n\nğŸ’° *Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:*\n1. Ø­ÙˆÙ„ 300 Ø¬Ù†ÙŠÙ‡ Ø¹Ù„Ù‰: ${CONTACT_INFO.vodafoneNumber}\n2. Ø§ÙƒØªØ¨ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${studentCode}\n3. Ø£Ø±Ø³Ù„ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø¹Ù„Ù‰: ${CONTACT_INFO.supportWhatsapp}\n\nâœ… *Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ ØªØ­ØµÙ„ Ø¹Ù„Ù‰:*\n- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙƒØ§Ù…Ù„Ø©\n- Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ÙˆØªØ¯Ø±ÙŠØ¨Ø§Øª\n- Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©\n- Ø´Ù‡Ø§Ø¯Ø© Ù…Ø¹ØªÙ…Ø¯Ø©\n\nğŸš€ *Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ ØªÙÙˆÙ‚Ø§Ù‹ Ø¨Ø§Ù‡Ø±Ø§Ù‹!*`;
            };

            // --- Authentication ---
            useEffect(() => {
                window.authMethods.onAuthStateChanged(window.auth, async (u) => {
                    if (u) {
                        const s = await window.rtdb.get(window.rtdb.child(window.rtdb.ref(window.db), `users/${u.uid}`));
                        if (s.exists()) { 
                            const userData = s.val();
                            setUser({ ...userData, uid: u.uid, photo: u.photoURL }); 
                            setView(['admin', 'boss'].includes(userData.role) ? 'admin' : 'student'); 
                            
                            // Check today's attendance
                            if (userData.role === 'student') {
                                const today = new Date().toISOString().split('T')[0];
                                const attRef = window.rtdb.ref(window.db, `attendance/${u.uid}/${today}`);
                                window.rtdb.get(attRef).then(snap => {
                                    setAttendanceChecked(!!snap.exists());
                                });
                            }
                        } else { 
                            setUser({ uid: u.uid, name: u.displayName, email: u.email, photo: u.photoURL, isNew: true }); 
                            setView('complete-profile'); 
                        }
                    } else { 
                        setUser(null); 
                        // Default case to prevent blue screen
                        if (!view || view === 'loading' || !['landing', 'guest', 'student-login', 'pending-approval'].includes(view)) {
                            setView('landing');
                        }
                    }
                });
            }, []);

            // --- Data Sync ---
            useEffect(() => {
                if (user || isGuestMode) {
                    // Sync lectures for all users
                    window.rtdb.onValue(window.rtdb.ref(window.db, 'lectures'), s => 
                        setDataState(p => ({ 
                            ...p, 
                            lectures: s.val() ? Object.entries(s.val()).map(([k, v]) => ({ id: k, ...v })).sort((a, b) => (b.ts || 0) - (a.ts || 0)) : [] 
                        }))
                    );
                    
                    window.rtdb.onValue(window.rtdb.ref(window.db, 'freeContent'), s => 
                        setDataState(p => ({ 
                            ...p, 
                            freeContent: s.val() ? Object.entries(s.val()).map(([k, v]) => ({ id: k, ...v })).sort((a, b) => (b.ts || 0) - (a.ts || 0)) : [] 
                        }))
                    );
                    
                    // Sync Q&A for all users
                    window.rtdb.onValue(window.rtdb.ref(window.db, 'qa'), s => 
                        setDataState(p => ({ 
                            ...p, 
                            qa: s.val() ? Object.entries(s.val()).map(([k, v]) => ({ id: k, ...v })).sort((a, b) => (b.ts || 0) - (a.ts || 0)) : [] 
                        }))
                    );
                    
                    window.rtdb.onValue(window.rtdb.ref(window.db, 'announcements'), s => 
                        setDataState(p => ({ 
                            ...p, 
                            announcements: s.val() ? Object.entries(s.val()).map(([k, v]) => ({ id: k, ...v })).sort((a, b) => (b.ts || 0) - (a.ts || 0)) : [] 
                        }))
                    );
                    
                    if (user && user.role === 'student') {
                        // Sync student-specific data
                        window.rtdb.onValue(window.rtdb.ref(window.db, `attendance/${user.uid}`), s => 
                            setDataState(p => ({ 
                                ...p, 
                                attendance: { ...p.attendance, [user.uid]: s.val() || {} } 
                            }))
                        );
                    }
                    
                    if (['admin', 'boss'].includes(user?.role)) {
                        // Sync admin-only data
                        window.rtdb.onValue(window.rtdb.ref(window.db, 'requests'), s => 
                            setDataState(p => ({ ...p, requests: s.val() ? Object.entries(s.val()).map(([k, v]) => ({ id: k, ...v })) : [] }))
                        );
                        window.rtdb.onValue(window.rtdb.ref(window.db, 'users'), s => 
                            setDataState(p => ({ ...p, students: s.val() ? Object.entries(s.val()).map(([k, v]) => ({ id: k, ...v })).filter(u => u.role === 'student') : [] }))
                        );
                        window.rtdb.onValue(window.rtdb.ref(window.db, 'payments'), s => 
                            setDataState(p => ({ ...p, payments: s.val() ? Object.entries(s.val()).map(([k, v]) => ({ id: k, ...v })) : [] }))
                        );
                        window.rtdb.onValue(window.rtdb.ref(window.db, 'subscriptions'), s => 
                            setDataState(p => ({ ...p, subscriptions: s.val() || {} }))
                        );
                        window.rtdb.onValue(window.rtdb.ref(window.db, 'attendance'), s => 
                            setDataState(p => ({ ...p, attendance: s.val() || {} }))
                        );
                        window.rtdb.onValue(window.rtdb.ref(window.db, 'exams'), s => 
                            setDataState(p => ({ ...p, exams: s.val() ? Object.entries(s.val()).map(([k, v]) => ({ id: k, ...v })) : [] }))
                        );
                        window.rtdb.onValue(window.rtdb.ref(window.db, 'whiteboards'), s => 
                            setDataState(p => ({ ...p, whiteboards: s.val() ? Object.entries(s.val()).map(([k, v]) => ({ id: k, ...v })) : [] }))
                        );
                    }
                }
            }, [user, isGuestMode]);

            // --- Helper Functions ---
            const renderContent = (link, type = 'video') => {
                if (!link) return null;
                if (link.trim().startsWith('<iframe') || link.trim().startsWith('<div')) 
                    return <div className="embed-wrapper" dangerouslySetInnerHTML={{__html: link}} />;
                if (link.includes('youtu')) {
                    const id = link.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/)?.[2];
                    return id ? <div className="embed-wrapper"><iframe src={`https://www.youtube.com/embed/${id}`} allowFullScreen></iframe></div> : null;
                }
                if (type === 'image' || link.match(/\.(jpeg|jpg|gif|png)$/) || link.includes('ibb.co')) {
                    return <img src={link} className="w-full rounded-xl shadow-lg border border-white/10" onError={(e)=>{e.target.src='https://placehold.co/600x400?text=Ø®Ø·Ø£';}} />;
                }
                if (link.includes('drive.google.com')) {
                    return <div className="embed-wrapper"><iframe src={link.replace('/view', '/preview').replace('/edit', '/preview')} allowFullScreen></iframe></div>;
                }
                return <a href={link} target="_blank" className="block w-full bg-white/10 text-white text-center py-3 rounded-xl font-bold border border-white/10 hover:bg-white/20">ğŸ”— ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</a>;
            };

            const calculateSubscriptionDays = (subscriptionEnd) => {
                if (!subscriptionEnd) return 0;
                const now = new Date();
                const end = new Date(subscriptionEnd);
                const diffTime = end - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays > 0 ? diffDays : 0;
            };

            const handleStudentLogin = async () => {
                if (studentLoginCode.length < 3) {
                    return showNotification('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ', 'error');
                }
                
                const student = dataState.students.find(s => s.code === studentLoginCode);
                if (student) {
                    if (student.status === 'pending') {
                        setView('pending-approval');
                    } else {
                        // Simulate login
                        setUser({ ...student, uid: student.id });
                        setView('student');
                        showNotification(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${student.firstName} ${student.secondName}!`);
                    }
                } else {
                    showNotification('Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
                }
            };

            const handleAdminLogin = async () => {
                if (!user) return showNotification('Ø³Ø¬Ù„ Ø¨Ø¬ÙˆØ¬Ù„ Ø§Ù„Ø£ÙˆÙ„', 'error');
                if (VALID_CODES[loginCode]) {
                    await window.rtdb.set(window.rtdb.ref(window.db, 'users/' + user.uid), { 
                        ...user, 
                        role: VALID_CODES[loginCode], 
                        isNew: false 
                    });
                    window.location.reload();
                } else showNotification('Ø§Ù„ÙƒÙˆØ¯ ØºÙ„Ø·ØŒ Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ', 'error');
            };

            const uploadItem = async (collection, data) => {
                await window.rtdb.push(window.rtdb.ref(window.db, collection), { 
                    ...data, 
                    date: new Date().toLocaleDateString('ar-EG'), 
                    ts: Date.now() 
                });
                showNotification('ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­ âœ…');
            };

            // ğŸ› ï¸ FIXED: updateStudent function with correct database path
            const updateStudent = async (id, data) => {
                try {
                    await window.rtdb.update(window.rtdb.ref(window.db, `users/${id}`), data);
                    showNotification('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ğŸ‘Œ');
                    
                    // Update local state
                    setDataState(prev => ({
                        ...prev,
                        students: prev.students.map(s => 
                            s.id === id ? { ...s, ...data } : s
                        )
                    }));
                } catch (error) {
                    console.error('Error updating student:', error);
                    showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'error');
                }
            };

            const addSubscription = async (studentId, months) => {
                const now = new Date();
                const end = new Date(now.setMonth(now.getMonth() + months));
                await window.rtdb.update(window.rtdb.ref(window.db, `subscriptions/${studentId}`), {
                    startDate: new Date().toISOString(),
                    endDate: end.toISOString(),
                    months: months
                });
                await updateStudent(studentId, { isPaid: true });
                showNotification(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ ${months} Ø´Ù‡Ø±`);
            };

            const markAttendance = async () => {
                if (!user || user.role !== 'student') return;
                
                // Check if today is a scheduled day
                const today = new Date();
                const dayName = today.toLocaleDateString('ar-EG', { weekday: 'long' });
                if (!user.scheduleDays || !user.scheduleDays.includes(dayName)) {
                    return showNotification('Ø§Ù„ÙŠÙˆÙ… Ù„ÙŠØ³ Ù…Ù† Ø£ÙŠØ§Ù… Ø­ØµØµÙƒ Ø§Ù„Ù…Ù‚Ø±Ø±Ø©', 'warning');
                }
                
                const todayStr = today.toISOString().split('T')[0];
                await window.rtdb.set(window.rtdb.ref(window.db, `attendance/${user.uid}/${todayStr}`), {
                    timestamp: Date.now(),
                    date: todayStr,
                    day: dayName
                });
                
                setAttendanceChecked(true);
                showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ Ø§Ù„ÙŠÙˆÙ…! ğŸ‰', 'success');
            };

            // ğŸ“± ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ - ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙØ¹
            const generatePaymentCode = () => {
                return `ALAMY${Date.now().toString().slice(-8)}`;
            };

            // ğŸ Guest Mode Functions
            const handleGuestMode = () => {
                setIsGuestMode(true);
                setView('guest');
                showNotification('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙƒØ²Ø§Ø¦Ø±! ÙŠÙ…ÙƒÙ†Ùƒ ØªØµÙØ­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ', 'info');
            };

            // ğŸ“¤ Send WhatsApp to Student
            const sendWhatsAppToStudent = (student) => {
                const message = generateWelcomeMessage(
                    `${student.firstName} ${student.secondName}`,
                    student.code,
                    student.phone
                );
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${student.parentPhone || student.phone}?text=${encodedMessage}`;
                window.open(whatsappUrl, '_blank');
            };

            // --- VIEWS ---

            try {
                // Default case for undefined view
                if (!view || !['landing', 'guest', 'student-login', 'pending-approval', 'complete-profile', 'student', 'admin', 'loading'].includes(view)) {
                    setView('landing');
                    return null;
                }

                // ğŸ¨ Landing Page - Ù…Ø­Ø¯Ø«
                if (view === 'landing') return (
                    <div className="min-h-screen bg-brand-dark text-white relative overflow-hidden math-grid flex flex-col">
                        <div className="absolute top-0 left-0 w-full h-full hero-glow z-0"></div>
                        
                        <header className="relative z-50 p-6 flex justify-between items-center container mx-auto">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-brand-accent rounded-lg flex items-center justify-center text-brand-dark font-black text-xl">âˆ‘</div>
                                <h1 className="text-2xl font-black tracking-tighter">Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ</h1>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={()=>window.authMethods.signInWithPopup(window.auth, window.googleProvider)} 
                                        className="bg-white/10 hover:bg-white/20 border border-white/20 px-6 py-2 rounded-full font-bold transition">
                                    ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„
                                </button>
                                <button onClick={()=>setView('student-login')} 
                                        className="bg-brand-primary/20 hover:bg-brand-primary/40 border border-brand-primary/30 px-6 py-2 rounded-full font-bold transition">
                                    Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨
                                </button>
                                <button onClick={handleGuestMode}
                                        className="bg-green-600/20 hover:bg-green-600/40 border border-green-500/30 px-6 py-2 rounded-full font-bold transition">
                                    ØªØµÙØ­ ÙƒØ²Ø§Ø¦Ø±
                                </button>
                            </div>
                        </header>

                        <div className="flex-1 container mx-auto px-4 flex flex-col-reverse md:flex-row items-center justify-center gap-10 relative z-20 py-10">
                            <div className="text-center md:text-right space-y-6 md:w-1/2 animate-slide-up">
                                <div className="inline-block bg-blue-500/20 text-blue-300 px-4 py-1 rounded-full text-sm font-bold border border-blue-500/30">
                                    ğŸš€ Ø£Ù‚ÙˆÙ‰ Ù…Ù†ØµØ© Ø±ÙŠØ§Ø¶ÙŠØ§Øª ÙÙŠ Ù…ØµØ±
                                </div>
                                
                                <h1 className="text-5xl md:text-7xl font-black leading-tight">
                                    Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª<br/>
                                    <span className="text-brand-accent">Ù„Ø¹Ø¨ØªÙƒ Ù…Ø¹Ø§Ù†Ø§!</span>
                                </h1>
                                
                                <p className="text-slate-300 text-lg md:text-xl font-medium max-w-lg mx-auto md:mx-0">
                                    Ù…Ø¹ Ø£/ Ø£Ø­Ù…Ø¯ Ø³Ø¹Ø¯ ÙŠÙˆÙ†Ø³.. Ø§Ù„ØªÙØ§Ø¶Ù„ ÙˆØ§Ù„ØªÙƒØ§Ù…Ù„ ÙˆØ§Ù„Ø¬Ø¨Ø± Ø¨Ù‚ÙˆØ§ Ø£Ø³Ù‡Ù„ Ù…Ù…Ø§ ØªØªØ®ÙŠÙ„. 
                                    Ø´Ø±Ø­ØŒ Ø­Ù„ØŒ Ù…ØªØ§Ø¨Ø¹Ø©ØŒ ÙˆØ§Ù…ØªØ­Ø§Ù†Ø§Øª Ø¯ÙˆØ±ÙŠØ© ØªØ¶Ù…Ù†Ù„Ùƒ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©.
                                </p>
                                
                                <div className="flex flex-col sm:flex-row gap-4 justify-center md:justify-start pt-4">
                                    <button onClick={()=>window.authMethods.signInWithPopup(window.auth, window.googleProvider)} 
                                            className="btn-main px-8 py-4 rounded-xl text-xl flex items-center justify-center gap-2">
                                        Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù† <SafeIcon name="calculator"/>
                                    </button>
                                </div>
                            </div>

                            <div className="md:w-1/2 relative flex justify-center items-end">
                                <div className="absolute inset-0 bg-brand-primary/30 blur-[100px] rounded-full"></div>
                                <img src="./alalamy.png" 
                                     className="relative z-10 w-full max-w-md object-contain drop-shadow-2xl animate-float hover:scale-105 transition-transform duration-500" 
                                     alt="Ø£/ Ø£Ø­Ù…Ø¯ Ø³Ø¹Ø¯ ÙŠÙˆÙ†Ø³" 
                                     onError={(e)=>{e.target.style.display='none'}}/>
                            </div>
                        </div>

                        <section className="py-20 relative z-20 bg-black/20 backdrop-blur-sm">
                            <div className="container mx-auto px-4">
                                <h2 className="text-4xl font-black text-center mb-16">Ù„ÙŠÙ‡ <span className="text-brand-accent">Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ</span> ÙŠÙƒØªØ³Ø­ØŸ ğŸ¤”</h2>
                                <div className="grid md:grid-cols-3 gap-8">
                                    {[
                                        { icon: 'brain', title: 'Ø´Ø±Ø­ ÙŠØ¯Ø®Ù„ Ø§Ù„Ù…Ø®', desc: 'Ø¨Ù†Ø¨Ø³Ø·Ù„Ùƒ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø© Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø© ÙˆÙ†Ø®Ù„ÙŠÙ‡Ø§ Ù…ÙŠÙ‡.. Ù…Ø´ Ù‡ØªØ­ÙØ¸ Ù‚ÙˆØ§Ù†ÙŠÙ†ØŒ Ù‡ØªÙÙ‡Ù…Ù‡Ø§ ÙˆØªÙ„Ø¹Ø¨ Ø¨ÙŠÙ‡Ø§.' },
                                        { icon: 'target', title: 'Ø­Ù„ ÙƒØªÙŠØ± Ø¬Ø¯Ø§Ù‹', desc: 'Ø¨Ù†Ø­Ù„ Ù…Ø¹Ø§Ùƒ Ù…Ù† ÙƒÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ø±.. ÙƒØªØ§Ø¨ Ù…Ø¹Ø§ØµØ±ØŒ Ø¨Ù†Ùƒ Ù…Ø¹Ø±ÙØ©ØŒ ÙˆØ§Ù…ØªØ­Ø§Ù†Ø§Øª Ø³Ù†ÙŠÙ† ÙØ§ØªØª.' },
                                        { icon: 'message-circle', title: 'Ù…ØªØ§Ø¨Ø¹Ø© 24 Ø³Ø§Ø¹Ø©', desc: 'Ø§Ù„Ø£Ø³ÙŠØ³ØªÙ†Øª ÙˆØ§Ù„Ù…Ø³ØªØ± Ù…Ø¹Ø§Ùƒ Ø¹Ù„Ù‰ Ø·ÙˆÙ„.. Ø§Ø³Ø£Ù„ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª Ù‡ØªÙ„Ø§Ù‚ÙŠ Ø§Ù„Ù„ÙŠ ÙŠØ±Ø¯ Ø¹Ù„ÙŠÙƒ.' }
                                    ].map((feature, idx) => (
                                        <div key={idx} className="glass-panel p-8 text-center hover:-translate-y-2 transition-transform duration-300">
                                            <div className="w-16 h-16 bg-brand-accent/20 rounded-full flex items-center justify-center mx-auto mb-4 text-brand-accent">
                                                <SafeIcon name={feature.icon} size={32}/>
                                            </div>
                                            <h3 className="text-xl font-bold mb-2">{feature.title}</h3>
                                            <p className="text-slate-400">{feature.desc}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </section>

                        {/* Ù…Ø­ØªÙˆÙ‰ Ù…Ø¬Ø§Ù†ÙŠ */}
                        <section className="py-10 bg-gradient-to-b from-black/20 to-brand-dark">
                            <div className="container mx-auto px-4">
                                <h2 className="text-3xl font-black text-center mb-8">Ù…Ø­ØªÙˆÙ‰ <span className="text-brand-accent">Ù…Ø¬Ø§Ù†ÙŠ</span> Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ù†ØµØ© ğŸ</h2>
                                <div className="grid md:grid-cols-3 gap-6">
                                    {dataState.freeContent.slice(0, 3).map(item => (
                                        <div key={item.id} className="glass-panel p-6 hover:border-brand-accent/50 transition cursor-pointer" onClick={()=>{setSelectedLecture(item); setShowFreeContent(true);}}>
                                            <div className="flex items-center gap-3 mb-3">
                                                <div className="w-10 h-10 bg-brand-accent/20 rounded-lg flex items-center justify-center">
                                                    <SafeIcon name={item.type === 'video' ? 'play-circle' : 'file-text'} className="text-brand-accent"/>
                                                </div>
                                                <div>
                                                    <h3 className="font-bold">{item.title}</h3>
                                                    <p className="text-xs text-slate-500">{item.grade === '1sec' ? 'Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ' : item.grade === '2sec' ? 'Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ' : 'Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ'}</p>
                                                </div>
                                            </div>
                                            <p className="text-sm text-slate-400 line-clamp-2">{item.description}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </section>

                        {/* Social Media Links */}
                        <section className="py-10 bg-brand-card/50 border-t border-white/5">
                            <div className="container mx-auto px-4">
                                <h3 className="text-center text-lg font-bold mb-6">ØªØ§Ø¨Ø¹Ù†Ø§ Ø¹Ù„Ù‰:</h3>
                                <div className="flex justify-center gap-6 flex-wrap">
                                    <a href={CONTACT_INFO.facebook} target="_blank" className="flex items-center gap-2 bg-blue-600/20 hover:bg-blue-600/40 border border-blue-500/30 px-6 py-3 rounded-xl transition">
                                        <SafeIcon name="facebook"/> Facebook
                                    </a>
                                    <a href={CONTACT_INFO.youtube} target="_blank" className="flex items-center gap-2 bg-red-600/20 hover:bg-red-600/40 border border-red-500/30 px-6 py-3 rounded-xl transition">
                                        <SafeIcon name="youtube"/> YouTube
                                    </a>
                                    <a href={CONTACT_INFO.whatsapp} target="_blank" className="flex items-center gap-2 bg-green-600/20 hover:bg-green-600/40 border border-green-500/30 px-6 py-3 rounded-xl transition">
                                        <SafeIcon name="message-circle"/> WhatsApp
                                    </a>
                                    <a href={CONTACT_INFO.telegram} target="_blank" className="flex items-center gap-2 bg-blue-400/20 hover:bg-blue-400/40 border border-blue-400/30 px-6 py-3 rounded-xl transition">
                                        <SafeIcon name="send"/> Telegram
                                    </a>
                                </div>
                            </div>
                        </section>

                        <div className="py-6 text-center text-slate-500 text-sm border-t border-white/5">
                            Developed with â¤ï¸ by Marwan | Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© 2025
                        </div>
                    </div>
                );

                // ğŸ‘¤ Guest Mode View
                if (view === 'guest') return (
                    <div className="min-h-screen bg-brand-dark text-white">
                        <header className="p-6 flex justify-between items-center border-b border-white/10">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-brand-accent rounded-lg flex items-center justify-center text-brand-dark font-black text-xl">âˆ‘</div>
                                <h1 className="text-2xl font-black">Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ - ÙˆØ¶Ø¹ Ø§Ù„Ø²Ø§Ø¦Ø±</h1>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={()=>{setIsGuestMode(false); setView('landing');}} 
                                        className="bg-white/10 hover:bg-white/20 border border-white/20 px-6 py-2 rounded-full font-bold transition">
                                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                                </button>
                                <button onClick={()=>window.authMethods.signInWithPopup(window.auth, window.googleProvider)} 
                                        className="btn-main px-6 py-2 rounded-full">
                                    Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†
                                </button>
                            </div>
                        </header>

                        <main className="container mx-auto p-6">
                            <div className="glass-panel p-6 mb-6">
                                <div className="flex items-center gap-3 mb-4">
                                    <SafeIcon name="user" size={24} className="text-brand-accent"/>
                                    <h2 className="text-2xl font-bold">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙƒØ²Ø§Ø¦Ø±! ğŸ‘‹</h2>
                                </div>
                                <p className="text-slate-400 mb-4">
                                    ÙŠÙ…ÙƒÙ†Ùƒ ØªØµÙØ­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ ÙˆÙ…Ø´Ø§Ù‡Ø¯Ø© Ø¹ÙŠÙ†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª. Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù‚Ù… Ø¨Ø§Ù„ØªØ³Ø¬ÙŠÙ„.
                                </p>
                                <div className="bg-blue-500/10 border border-blue-500/30 p-4 rounded-xl">
                                    <p className="text-sm text-blue-300">
                                        <SafeIcon name="info" className="inline mr-2"/> ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø±:
                                    </p>
                                    <ul className="mt-2 space-y-2 text-sm text-slate-300">
                                        <li className="flex items-center gap-2">
                                            <SafeIcon name="check-circle" size={16} className="text-green-500"/>
                                            Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©
                                        </li>
                                        <li className="flex items-center gap-2">
                                            <SafeIcon name="check-circle" size={16} className="text-green-500"/>
                                            Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø£Ø¬ÙˆØ¨Ø©
                                        </li>
                                        <li className="flex items-center gap-2">
                                            <SafeIcon name="x-circle" size={16} className="text-red-500"/>
                                            Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù†Ø´Ø± Ø£Ø³Ø¦Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
                                        </li>
                                        <li className="flex items-center gap-2">
                                            <SafeIcon name="x-circle" size={16} className="text-red-500"/>
                                            Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            {/* Ù…Ø­ØªÙˆÙ‰ Ù…Ø¬Ø§Ù†ÙŠ Ù„Ù„Ø²ÙˆØ§Ø± */}
                            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {dataState.freeContent.map(item => (
                                    <div key={item.id} className="glass-panel overflow-hidden cursor-pointer group hover:border-brand-accent/50 transition duration-300">
                                        <div className="h-44 bg-gradient-to-br from-blue-900/30 to-purple-900/30 relative flex items-center justify-center">
                                            <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                                            <SafeIcon name={item.type === 'video' ? 'play-circle' : 'file-text'} size={56} className="text-white/80 relative z-10 group-hover:scale-110 group-hover:text-brand-accent transition"/>
                                            <div className="absolute top-3 left-3 bg-brand-accent text-brand-dark px-2 py-1 rounded text-xs font-bold">
                                                Ù…Ø¬Ø§Ù†ÙŠ
                                            </div>
                                        </div>
                                        <div className="p-5">
                                            <h3 className="font-bold text-lg mb-2 truncate">{item.title}</h3>
                                            <p className="text-xs text-slate-400 line-clamp-2">{item.description}</p>
                                            <div className="flex items-center gap-2 mt-3 text-xs text-slate-500">
                                                <SafeIcon name="clock" size={12}/>
                                                <span>{item.duration || '--'}</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Ø£Ø³Ø¦Ù„Ø© Ø¹Ø§Ù…Ø© (Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·) */}
                            <div className="glass-panel p-6 mt-6">
                                <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                                    <SafeIcon name="help-circle" className="text-brand-accent"/> Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
                                </h3>
                                <div className="space-y-4 max-h-96 overflow-y-auto">
                                    {dataState.qa.slice(0, 10).map(q => (
                                        <div key={q.id} className="bg-white/5 p-4 rounded-xl">
                                            <div className="flex items-center gap-3 mb-3">
                                                <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold">
                                                    {q.studentName?.[0] || '?'}
                                                </div>
                                                <div>
                                                    <p className="font-bold text-sm">{q.studentName || 'Ø·Ø§Ù„Ø¨'}</p>
                                                    <p className="text-xs text-slate-500">{q.date}</p>
                                                </div>
                                            </div>
                                            <p className="text-slate-200 bg-black/20 p-3 rounded-lg mb-3">{q.question}</p>
                                            {q.reply && (
                                                <div className="flex gap-3 ml-4 bg-brand-primary/10 p-3 rounded-lg border-r-2 border-brand-primary">
                                                    <div className="shrink-0"><SafeIcon name="corner-down-left" className="text-brand-primary"/></div>
                                                    <div>
                                                        <p className="text-xs font-bold text-brand-primary mb-1">Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ±:</p>
                                                        <p className="text-sm text-slate-300">{q.reply}</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </main>
                    </div>
                );

                // ğŸ” ØµÙØ­Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø§Ù„ÙƒÙˆØ¯
                if (view === 'student-login') return (
                    <div className="min-h-screen bg-brand-dark flex items-center justify-center p-4">
                        <div className="glass-panel p-8 w-full max-w-md animate-slide-up">
                            <div className="text-center mb-8">
                                <div className="w-20 h-20 bg-brand-accent/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <SafeIcon name="key" size={40} className="text-brand-accent"/>
                                </div>
                                <h2 className="text-3xl font-bold text-white mb-2">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
                                <p className="text-slate-400">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„</p>
                            </div>

                            <div className="space-y-6">
                                <input 
                                    className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none text-white text-center text-2xl tracking-widest font-mono" 
                                    placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯" 
                                    value={studentLoginCode}
                                    onChange={e=>setStudentLoginCode(e.target.value.toUpperCase())}
                                    maxLength="15"
                                />
                                
                                <button 
                                    onClick={handleStudentLogin} 
                                    className="btn-main w-full py-4 rounded-xl text-lg font-bold flex items-center justify-center gap-2"
                                >
                                    <SafeIcon name="log-in"/> Ø¯Ø®ÙˆÙ„
                                </button>
                                
                                <div className="text-center">
                                    <p className="text-slate-500 text-sm mb-2">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ÙƒÙˆØ¯ØŸ</p>
                                    <button onClick={()=>window.authMethods.signInWithPopup(window.auth, window.googleProvider)} 
                                            className="text-brand-accent hover:underline">
                                        Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù† ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ø®Ø§Øµ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );

                // â³ ØµÙØ­Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
                if (view === 'pending-approval') return (
                    <div className="min-h-screen bg-brand-dark flex items-center justify-center p-4">
                        <div className="glass-panel p-8 w-full max-w-lg animate-slide-up">
                            <div className="text-center mb-8">
                                <div className="w-24 h-24 bg-brand-accent/20 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce-slow">
                                    <SafeIcon name="clock" size={48} className="text-brand-accent"/>
                                </div>
                                <h2 className="text-3xl font-bold text-white mb-4">Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ! ğŸ“‹</h2>
                                <p className="text-slate-300 mb-6">
                                    ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø·Ù„Ø¨ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø¨Ù†Ø¬Ø§Ø­. ÙØ±ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙŠÙ‚ÙˆÙ… Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.
                                </p>
                                <div className="bg-blue-500/10 border border-blue-500/30 p-4 rounded-xl">
                                    <p className="text-sm text-blue-300">
                                        <SafeIcon name="info" className="inline mr-2"/> Ø³ØªØµÙ„Ùƒ Ø±Ø³Ø§Ù„Ø© Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰:
                                    </p>
                                    <ul className="text-right mt-2 space-y-1 text-sm text-slate-400">
                                        <li>âœ… ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</li>
                                        <li>âœ… Ø®Ø·ÙˆØ§Øª ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</li>
                                        <li>âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„</li>
                                        <li>âœ… Ø£ÙŠØ§Ù… Ø§Ù„Ø­ØµØµ Ø§Ù„Ù…Ù‚Ø±Ø±Ø©</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div className="text-center">
                                <button onClick={()=>setView('landing')} 
                                        className="px-6 py-2 bg-white/10 hover:bg-white/20 rounded-lg font-bold transition">
                                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                                </button>
                            </div>
                        </div>
                    </div>
                );

                // ğŸ“ Complete Profile - Ù…Ø­Ø¯Ø«
                if (view === 'complete-profile') return (
                    <div className="min-h-screen bg-brand-dark flex items-center justify-center p-4">
                        <div className="glass-panel p-8 w-full max-w-2xl animate-slide-up">
                            <div className="text-center mb-8">
                                <img src={user.photo} className="w-20 h-20 rounded-full mx-auto mb-4 border-4 border-brand-accent"/>
                                <h2 className="text-3xl font-bold text-white mb-2">Ø£Ù‡Ù„Ø§Ù‹! ğŸ‘‹</h2>
                                <p className="text-slate-400">ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¹Ø´Ø§Ù† Ù†Ø¨Ø¯Ø£ Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</p>
                            </div>

                            <div className="space-y-4">
                                <div className="grid md:grid-cols-3 gap-4">
                                    <input 
                                        className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none text-white" 
                                        placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ *" 
                                        onChange={e=>setRegData({...regData, firstName: e.target.value})}
                                    />
                                    <input 
                                        className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none text-white" 
                                        placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ *" 
                                        onChange={e=>setRegData({...regData, secondName: e.target.value})}
                                    />
                                    <input 
                                        className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none text-white" 
                                        placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù„Ø« *" 
                                        onChange={e=>setRegData({...regData, thirdName: e.target.value})}
                                    />
                                </div>

                                <div className="grid md:grid-cols-2 gap-4">
                                    <input 
                                        className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none text-white" 
                                        placeholder="Ø±Ù‚Ù… ØªÙ„ÙŠÙÙˆÙ†Ùƒ ğŸ“± *" 
                                        onChange={e=>setRegData({...regData, phone: e.target.value})}
                                    />
                                    <input 
                                        className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none text-white" 
                                        placeholder="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ *" 
                                        onChange={e=>setRegData({...regData, parentPhone: e.target.value})}
                                    />
                                </div>

                                <input 
                                    className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none text-white" 
                                    placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ğŸ« *" 
                                    onChange={e=>setRegData({...regData, school: e.target.value})}
                                />

                                <div className="grid md:grid-cols-2 gap-4">
                                    <input 
                                        className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none text-white" 
                                        placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© ğŸ—ºï¸ *" 
                                        onChange={e=>setRegData({...regData, governorate: e.target.value})}
                                    />
                                    <input 
                                        className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none text-white" 
                                        placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / Ø§Ù„Ù…Ø±ÙƒØ² ğŸ“ *" 
                                        onChange={e=>setRegData({...regData, city: e.target.value})}
                                    />
                                </div>

                                <input 
                                    className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none text-white" 
                                    placeholder="Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ğŸ¯" 
                                    onChange={e=>setRegData({...regData, center: e.target.value})}
                                />

                                <textarea 
                                    className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none text-white" 
                                    placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ ğŸ " 
                                    rows="2"
                                    onChange={e=>setRegData({...regData, address: e.target.value})}
                                />

                                <div className="grid md:grid-cols-2 gap-4">
                                    <select 
                                        className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none text-white" 
                                        onChange={e=>setRegData({...regData, grade: e.target.value})}
                                    >
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ *</option>
                                        <option value="1sec">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                                        <option value="2sec">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                                        <option value="3sec">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                                    </select>

                                    <select 
                                        className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none text-white" 
                                        onChange={e=>setRegData({...regData, scheduleDays: e.target.value})}
                                    >
                                        <option value="">Ø£ÙŠØ§Ù… Ø§Ù„Ø­ØµØµ Ø§Ù„Ù…ÙØ¶Ù„Ø© *</option>
                                        <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ† ÙˆØ§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø§Ø«Ù†ÙŠÙ† ÙˆØ§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
                                        <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ ÙˆØ§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ ÙˆØ§Ù„Ø®Ù…ÙŠØ³</option>
                                        <option value="Ø§Ù„Ø³Ø¨Øª ÙˆØ§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø³Ø¨Øª ÙˆØ§Ù„Ø£Ø­Ø¯</option>
                                        <option value="Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠØ§Ù…">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠØ§Ù…</option>
                                    </select>
                                </div>

                                <div className="bg-blue-500/10 border border-blue-500/30 p-4 rounded-xl">
                                    <p className="text-sm text-blue-300 mb-2">
                                        <SafeIcon name="info" className="inline mr-2"/> Ù…Ù„Ø§Ø­Ø¸Ø©:
                                    </p>
                                    <p className="text-xs text-slate-400">
                                        Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡Ø§ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ³ÙŠØµÙ„ Ù„Ùƒ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©.
                                        Ø³ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø².
                                    </p>
                                </div>

                                <button 
                                    onClick={async()=>{
                                        const required = ['firstName', 'secondName', 'phone', 'parentPhone', 'school', 'governorate', 'city', 'grade', 'scheduleDays'];
                                        const missing = required.filter(field => !regData[field]);
                                        
                                        if(missing.length > 0) {
                                            return showNotification('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (*)', 'error');
                                        }
                                        
                                        const fullName = `${regData.firstName} ${regData.secondName} ${regData.thirdName || ''}`.trim();
                                        const studentCode = generateStudentCode();
                                        
                                        await window.rtdb.set(window.rtdb.push(window.rtdb.ref(window.db, 'requests')), { 
                                            ...regData, 
                                            name: fullName,
                                            uid: user.uid, 
                                            email: user.email, 
                                            photo: user.photo, 
                                            code: studentCode,
                                            status: 'pending',
                                            date: new Date().toLocaleDateString(),
                                            ts: Date.now()
                                        });
                                        
                                        showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ! Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ Ù‚Ø±ÙŠØ¨Ø§Ù‹');
                                        setTimeout(()=>{
                                            setView('pending-approval');
                                        }, 2000);
                                    }} 
                                    className="btn-main w-full py-4 rounded-xl text-lg font-bold flex items-center justify-center gap-2"
                                >
                                    <SafeIcon name="send"/> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                                </button>
                            </div>
                        </div>
                    </div>
                );

                // ğŸ“ Student View - Ù…Ø­Ø¯Ø«
                if (view === 'student') {
                    const daysLeft = calculateSubscriptionDays(dataState.subscriptions[user.uid]?.endDate);
                    const attendanceCount = Object.keys(dataState.attendance[user.uid] || {}).length;
                    const attendanceRank = calculateRank('attendance', attendanceCount);
                    
                    // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØµÙ
                    const filteredLectures = dataState.lectures.filter(lec => 
                        !lec.grade || lec.grade === user.grade || lec.grade === 'all'
                    );
                    
                    return (
                        <div className="min-h-screen bg-brand-dark text-white flex flex-col md:flex-row">
                            {/* Sidebar */}
                            <aside className={`fixed inset-y-0 right-0 z-50 w-72 bg-brand-card border-l border-white/5 flex flex-col transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : 'translate-x-full'} md:translate-x-0 md:static shrink-0`}>
                                <div className="p-6 text-center border-b border-white/5">
                                    <div className="relative inline-block">
                                        <img src={user.photo} className="w-20 h-20 rounded-full border-4 border-brand-dark mx-auto mb-3"/>
                                        <div className={`absolute bottom-2 right-0 w-5 h-5 rounded-full border-2 border-brand-card ${user.isPaid?'bg-green-500':'bg-red-500'}`}></div>
                                    </div>
                                    <h3 className="font-bold text-lg">{user.firstName} {user.secondName}</h3>
                                    <p className="text-xs text-slate-400 font-mono mt-1">{user.code}</p>
                                    
                                    {/* Attendance Badge */}
                                    <div className="mt-2" style={{ color: attendanceRank.color }}>
                                        <div className="flex items-center justify-center gap-1 text-sm">
                                            <SafeIcon name="calendar-check" size={14}/>
                                            <span className="font-bold">{attendanceCount}</span>
                                            <span className="text-xs"> - {attendanceRank.name}</span>
                                        </div>
                                    </div>
                                    
                                    {user.isPaid && daysLeft > 0 && (
                                        <div className="mt-2 bg-green-500/20 text-green-300 px-3 py-1 rounded-full text-xs">
                                            Ø¨Ø§Ù‚ÙŠ {daysLeft} ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
                                        </div>
                                    )}
                                </div>

                                <nav className="p-4 space-y-2 flex-1">
                                    {[
                                        {id:'home', l:'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', i:'home'},
                                        {id:'lectures', l:'Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª', i:'play-circle'},
                                        {id:'subscription', l:'Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', i:'credit-card'},
                                        {id:'qa', l:'Ø£Ø³Ø¦Ù„Ø© ÙˆØ£Ø¬ÙˆØ¨Ø©', i:'help-circle'},
                                        {id:'free', l:'Ù…Ø­ØªÙˆÙ‰ Ù…Ø¬Ø§Ù†ÙŠ', i:'gift'},
                                        {id:'progress', l:'ØªÙ‚Ø¯Ù…ÙŠ', i:'trending-up'},
                                        {id:'attendance', l:'Ø§Ù„Ø­Ø¶ÙˆØ±', i:'calendar-check'}
                                    ].map(item => (
                                        <button key={item.id} onClick={()=>{setActiveTab(item.id); setSelectedLecture(null); setSidebarOpen(false); setCurrentLectureStep('video');}} 
                                                className={`w-full flex items-center gap-3 p-3 rounded-xl transition font-bold ${activeTab===item.id ? 'bg-brand-primary text-white shadow-lg' : 'text-slate-400 hover:bg-white/5 hover:text-white'}`}>
                                            <SafeIcon name={item.i} size={20}/> {item.l}
                                        </button>
                                    ))}
                                </nav>

                                {/* Attendance Button - ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ø­ØµØµ */}
                                {user.scheduleDays && (() => {
                                    const today = new Date();
                                    const dayName = today.toLocaleDateString('ar-EG', { weekday: 'long' });
                                    const isScheduledDay = user.scheduleDays.includes(dayName);
                                    
                                    return isScheduledDay ? (
                                        <div className="p-4 border-t border-white/5">
                                            <button 
                                                onClick={markAttendance}
                                                disabled={attendanceChecked}
                                                className={`w-full flex items-center justify-center gap-2 p-3 rounded-xl font-bold transition ${attendanceChecked ? 'bg-gray-800 text-gray-500 cursor-not-allowed' : 'bg-green-600/20 border border-green-500/30 text-green-300 hover:bg-green-600/40 attendance-btn'}`}
                                            >
                                                <SafeIcon name={attendanceChecked ? 'check-circle' : 'calendar-plus'} size={18}/>
                                                {attendanceChecked ? 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ… âœ“' : `Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ… (${dayName})`}
                                            </button>
                                        </div>
                                    ) : null;
                                })()}

                                {/* Support Button */}
                                <div className="p-4 border-t border-white/5 space-y-2">
                                    <a href={CONTACT_INFO.supportWhatsapp} target="_blank" 
                                       className="flex items-center justify-center gap-2 bg-green-600/20 border border-green-500/30 text-green-300 w-full p-3 rounded-xl font-bold hover:bg-green-600/40 transition">
                                        <SafeIcon name="headphones" size={18}/> Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ
                                    </a>
                                    <button onClick={()=>window.authMethods.signOut(window.auth)} 
                                            className="flex items-center justify-center gap-2 text-red-400 w-full p-3 hover:bg-red-500/10 rounded-xl font-bold transition">
                                        <SafeIcon name="log-out" size={18}/> Ø®Ø±ÙˆØ¬
                                    </button>
                                </div>
                            </aside>

                            {/* Main Content */}
                            <div className="flex-1 flex flex-col h-screen overflow-y-auto bg-brand-dark relative">
                                <div className="absolute inset-0 math-grid opacity-10 pointer-events-none"></div>
                                
                                <header className="p-4 flex justify-between items-center md:hidden sticky top-0 z-40 bg-brand-dark/80 backdrop-blur-md border-b border-white/5">
                                    <h1 className="font-black text-xl text-brand-accent">Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ</h1>
                                    <button onClick={()=>setSidebarOpen(true)}><SafeIcon name="menu" className="text-white"/></button>
                                </header>

                                <main className="p-4 md:p-8 max-w-6xl mx-auto w-full relative z-10">
                                    {/* Locked State - Ù…Ø­Ø³Ù‘Ù† */}
                                    {!user.isPaid && activeTab !== 'home' && activeTab !== 'subscription' && activeTab !== 'free' ? (
                                        <div className="glass-panel p-10 text-center mt-10 animate-slide-up">
                                            <div className="w-20 h-20 bg-brand-accent/20 rounded-full flex items-center justify-center mx-auto mb-6">
                                                <SafeIcon name="lock" size={40} className="text-brand-accent"/>
                                            </div>
                                            <h2 className="text-3xl font-bold mb-3">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…ØºÙ„Ù‚ ğŸ”’</h2>
                                            <p className="text-slate-400 mb-6 max-w-md mx-auto">
                                                Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…ØªØ§Ø­ Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙÙ‚Ø·. Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù† Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰:
                                            </p>
                                            <ul className="text-right mb-8 space-y-2 max-w-md mx-auto text-slate-300">
                                                <li className="flex justify-between items-center">
                                                    <span>Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©</span>
                                                    <SafeIcon name="check-circle" className="text-green-500"/>
                                                </li>
                                                <li className="flex justify-between items-center">
                                                    <span>Ø§Ù„ØµØ¨ÙˆØ±Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</span>
                                                    <SafeIcon name="check-circle" className="text-green-500"/>
                                                </li>
                                                <li className="flex justify-between items-center">
                                                    <span>Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…</span>
                                                    <SafeIcon name="check-circle" className="text-green-500"/>
                                                </li>
                                                <li className="flex justify-between items-center">
                                                    <span>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…</span>
                                                    <SafeIcon name="check-circle" className="text-green-500"/>
                                                </li>
                                            </ul>
                                            <button onClick={()=>setActiveTab('subscription')} className="btn-main px-8 py-3 rounded-xl text-lg">Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†</button>
                                        </div>
                                    ) : (
                                        <>
                                            {/* Home Tab */}
                                            {activeTab === 'home' && (
                                                <div className="space-y-6 animate-slide-up">
                                                    <div className="bg-gradient-to-r from-brand-primary to-blue-900 rounded-2xl p-8 relative overflow-hidden shadow-2xl">
                                                        <div className="relative z-10">
                                                            <h2 className="text-3xl font-black mb-2">Ø£Ù‡Ù„Ø§Ù‹ {user.firstName} ğŸ‘‹</h2>
                                                            <p className="text-blue-100 mb-6">Ù…Ø³ØªØ¹Ø¯ ØªÙƒØ³Ø± Ø§Ù„Ø¯Ù†ÙŠØ§ ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶Ø©ØŸ</p>
                                                            <div className="flex flex-wrap gap-4">
                                                                <div className="bg-black/30 px-4 py-2 rounded-lg flex items-center gap-2 border border-white/10">
                                                                    <SafeIcon name="video" size={16} className="text-brand-accent"/> {filteredLectures.length} Ù…Ø­Ø§Ø¶Ø±Ø©
                                                                </div>
                                                                <div className="bg-black/30 px-4 py-2 rounded-lg flex items-center gap-2 border border-white/10">
                                                                    <SafeIcon name="calendar-check" size={16} style={{color: attendanceRank.color}}/> {attendanceCount} ÙŠÙˆÙ… Ø­Ø¶ÙˆØ±
                                                                </div>
                                                                {user.isPaid && daysLeft > 0 && (
                                                                    <>
                                                                        <div className="bg-green-500/20 px-4 py-2 rounded-lg flex items-center gap-2 border border-green-500">
                                                                            <SafeIcon name="calendar" size={16} className="text-green-300"/> Ø¨Ø§Ù‚ÙŠ {daysLeft} ÙŠÙˆÙ…
                                                                        </div>
                                                                        <div className="bg-blue-500/20 px-4 py-2 rounded-lg flex items-center gap-2 border border-blue-500">
                                                                            <SafeIcon name="clock" size={16} className="text-blue-300"/> Ø£ÙŠØ§Ù… Ø§Ù„Ø­ØµØµ: {user.scheduleDays}
                                                                        </div>
                                                                    </>
                                                                )}
                                                            </div>
                                                        </div>
                                                        <SafeIcon name="calculator" size={200} className="absolute -bottom-10 -left-10 text-white/5 rotate-12"/>
                                                    </div>

                                                    {/* Quick Stats */}
                                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                        <div className="glass-panel p-4 text-center">
                                                            <div className="text-2xl font-bold text-brand-accent mb-1">{attendanceCount}</div>
                                                            <div className="text-xs text-slate-400">ÙŠÙˆÙ… Ø­Ø¶ÙˆØ±</div>
                                                        </div>
                                                        <div className="glass-panel p-4 text-center">
                                                            <div className="text-2xl font-bold text-green-500 mb-1">{user.examsCompleted || 0}</div>
                                                            <div className="text-xs text-slate-400">Ø§Ù…ØªØ­Ø§Ù† Ù…ÙƒØªÙ…Ù„</div>
                                                        </div>
                                                        <div className="glass-panel p-4 text-center">
                                                            <div className="text-2xl font-bold text-blue-500 mb-1">{user.questionsAsked || 0}</div>
                                                            <div className="text-xs text-slate-400">Ø³Ø¤Ø§Ù„ Ù…Ø·Ø±ÙˆØ­</div>
                                                        </div>
                                                        <div className="glass-panel p-4 text-center">
                                                            <div className="text-2xl font-bold text-purple-500 mb-1">{user.accuracy || '0%'}</div>
                                                            <div className="text-xs text-slate-400">Ø¯Ù‚Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</div>
                                                        </div>
                                                    </div>

                                                    {user.notes && (
                                                        <div className="glass-panel p-6 border-r-4 border-brand-accent flex gap-4 items-start">
                                                            <SafeIcon name="lightbulb" className="text-brand-accent shrink-0 mt-1"/>
                                                            <div>
                                                                <h3 className="font-bold text-brand-accent mb-1">Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ±:</h3>
                                                                <p className="text-slate-300 leading-relaxed">{user.notes}</p>
                                                            </div>
                                                        </div>
                                                    )}

                                                    <div className="glass-panel p-6">
                                                        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                                                            <SafeIcon name="bell" className="text-brand-accent"/> Ø£Ø­Ø¯Ø« Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
                                                        </h3>
                                                        <div className="space-y-3">
                                                            {dataState.announcements.length === 0 ? (
                                                                <p className="text-slate-500 text-center py-4">Ù…ÙÙŠØ´ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                                                            ) : (
                                                                dataState.announcements.slice(0, 3).map(ann => (
                                                                    <div key={ann.id} className="bg-white/5 p-4 rounded-xl border-r-4 border-brand-primary">
                                                                        <h4 className="font-bold text-white">{ann.title}</h4>
                                                                        <p className="text-slate-400 text-sm mt-1">{ann.content}</p>
                                                                        <span className="text-xs text-slate-600 mt-2 block">{ann.date}</span>
                                                                    </div>
                                                                ))
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Progress Tab */}
                                            {activeTab === 'progress' && (
                                                <div className="space-y-6 animate-slide-up">
                                                    <div className="glass-panel p-6">
                                                        <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                                                            <SafeIcon name="trending-up" className="text-brand-accent"/> ØªÙ‚Ø¯Ù…ÙŠ ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                                                        </h2>
                                                        
                                                        <div className="grid md:grid-cols-2 gap-6">
                                                            {/* Attendance Progress */}
                                                            <div className="bg-white/5 p-6 rounded-xl">
                                                                <h3 className="font-bold mb-4 flex items-center gap-2">
                                                                    <SafeIcon name="calendar-check" style={{color: attendanceRank.color}}/>
                                                                    Ø±ØªØ¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±: {attendanceRank.name}
                                                                </h3>
                                                                <div className="space-y-2">
                                                                    <div className="flex justify-between text-sm">
                                                                        <span>Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</span>
                                                                        <span className="font-bold">{attendanceCount}</span>
                                                                    </div>
                                                                    <div className="h-2 bg-white/10 rounded-full overflow-hidden">
                                                                        <div className="h-full bg-green-500 rounded-full" style={{width: `${Math.min(100, (attendanceCount / 100) * 100)}%`}}></div>
                                                                    </div>
                                                                    <div className="text-xs text-slate-500 mt-2">
                                                                        Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ: {attendanceRank.level < 5 ? RANK_SYSTEM.attendance[attendanceRank.level].name : 'Ø£Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰'}
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            {/* Performance */}
                                                            <div className="bg-white/5 p-6 rounded-xl">
                                                                <h3 className="font-bold mb-4 flex items-center gap-2">
                                                                    <SafeIcon name="target"/> Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ
                                                                </h3>
                                                                <div className="space-y-3">
                                                                    <div className="flex items-center justify-between">
                                                                        <span className="text-sm">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</span>
                                                                        <span className="font-bold text-lg text-green-500">{user.avgScore || '--'}%</span>
                                                                    </div>
                                                                    <div className="flex items-center justify-between">
                                                                        <span className="text-sm">Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</span>
                                                                        <span className="font-bold">{user.completedLectures || 0}/{filteredLectures.length}</span>
                                                                    </div>
                                                                    <div className="flex items-center justify-between">
                                                                        <span className="text-sm">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</span>
                                                                        <span className="font-bold">{user.examsCompleted || 0}</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Monthly Progress */}
                                                    <div className="glass-panel p-6">
                                                        <h3 className="font-bold mb-4">ØªÙ‚Ø¯Ù…ÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
                                                        <div className="grid grid-cols-7 gap-2">
                                                            {Array.from({length: 30}).map((_, i) => (
                                                                <div key={i} className={`h-8 rounded ${Math.random() > 0.3 ? 'bg-green-500/50' : 'bg-white/10'}`}></div>
                                                            ))}
                                                        </div>
                                                        <div className="flex justify-between mt-2 text-xs text-slate-500">
                                                            <span>Ø§Ù„Ø­Ø¶ÙˆØ±</span>
                                                            <span>Ø§Ù„ØºÙŠØ§Ø¨</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Attendance Tab */}
                                            {activeTab === 'attendance' && (
                                                <div className="space-y-6 animate-slide-up">
                                                    <div className="glass-panel p-6">
                                                        <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                                                            <SafeIcon name="calendar-check" className="text-brand-accent"/> Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±
                                                        </h2>
                                                        
                                                        <div className="mb-6 bg-gradient-to-r from-brand-accent/20 to-transparent p-4 rounded-xl">
                                                            <div className="flex items-center justify-between">
                                                                <div>
                                                                    <h3 className="font-bold text-lg" style={{color: attendanceRank.color}}>
                                                                        {attendanceRank.name}
                                                                    </h3>
                                                                    <p className="text-sm text-slate-400">Ø±ØªØ¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
                                                                </div>
                                                                <div className="text-right">
                                                                    <div className="text-3xl font-bold">{attendanceCount}</div>
                                                                    <div className="text-sm text-slate-400">ÙŠÙˆÙ… Ø­Ø¶ÙˆØ±</div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div className="grid grid-cols-7 gap-2 mb-6">
                                                            {['Ø£Ø­Ø¯', 'Ø§Ø«Ù†ÙŠÙ†', 'Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø®Ù…ÙŠØ³', 'Ø¬Ù…Ø¹Ø©', 'Ø³Ø¨Øª'].map(day => (
                                                                <div key={day} className="text-center text-sm text-slate-400 py-2">{day}</div>
                                                            ))}
                                                            {Array.from({length: 35}).map((_, i) => {
                                                                const date = new Date();
                                                                date.setDate(date.getDate() - 34 + i);
                                                                const dateStr = date.toISOString().split('T')[0];
                                                                const hasAttendance = dataState.attendance[user.uid]?.[dateStr];
                                                                
                                                                return (
                                                                    <div key={i} className={`h-10 rounded flex items-center justify-center ${hasAttendance ? 'bg-green-500/50' : 'bg-white/5'}`}>
                                                                        {hasAttendance ? <SafeIcon name="check" size={16} className="text-white"/> : date.getDate()}
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>

                                                        <div className="bg-white/5 p-4 rounded-xl">
                                                            <h4 className="font-bold mb-3">Ù…Ø³ØªÙˆÙŠØ§Øª Ø±ØªØ¨ Ø§Ù„Ø­Ø¶ÙˆØ±:</h4>
                                                            <div className="space-y-2">
                                                                {RANK_SYSTEM.attendance.map(rank => (
                                                                    <div key={rank.level} className="flex items-center justify-between">
                                                                        <div className="flex items-center gap-2">
                                                                            <div className="w-3 h-3 rounded-full" style={{backgroundColor: rank.color}}></div>
                                                                            <span className="text-sm">{rank.name}</span>
                                                                        </div>
                                                                        <span className="text-xs text-slate-500">Ù…Ù† {rank.min} ÙŠÙˆÙ…</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Subscription Tab */}
                                            {activeTab === 'subscription' && (
                                                <div className="max-w-2xl mx-auto space-y-6 animate-slide-up">
                                                    <div className="glass-panel p-8">
                                                        <h2 className="text-2xl font-bold text-brand-accent mb-6 flex items-center gap-2">
                                                            <SafeIcon name="credit-card"/> Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨
                                                        </h2>
                                                        
                                                        <div className="space-y-6">
                                                            {/* Vodafone Cash Payment */}
                                                            <div className="bg-red-600/10 border border-red-500/30 p-6 rounded-xl">
                                                                <div className="flex items-center gap-3 mb-4">
                                                                    <div className="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center">
                                                                        <SafeIcon name="smartphone" size={24}/>
                                                                    </div>
                                                                    <div>
                                                                        <h3 className="font-bold text-lg">ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</h3>
                                                                        <p className="text-sm text-slate-400">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£Ø³Ø±Ø¹ Ù„Ù„Ø¯ÙØ¹</p>
                                                                    </div>
                                                                </div>

                                                                <div className="bg-black/30 p-4 rounded-lg mb-4">
                                                                    <p className="text-sm text-slate-400 mb-2">Ø­ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù…:</p>
                                                                    <div className="flex items-center justify-between">
                                                                        <span className="font-mono text-2xl font-bold text-white select-all">{CONTACT_INFO.vodafoneNumber}</span>
                                                                        <div className="text-xs bg-red-600/20 text-red-400 px-3 py-1 rounded-full">Vodafone Cash</div>
                                                                    </div>
                                                                </div>

                                                                <div className="bg-brand-accent/10 p-4 rounded-lg mb-4">
                                                                    <p className="text-sm mb-2">ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠÙƒ:</p>
                                                                    <div className="font-mono text-xl font-bold text-brand-accent select-all">{generatePaymentCode()}</div>
                                                                    <p className="text-xs text-slate-400 mt-2">Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯ Ø¯Ù‡ ÙÙŠ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„</p>
                                                                </div>
                                                            </div>

                                                            {/* Instructions */}
                                                            <div className="space-y-3 text-sm text-slate-300">
                                                                <h4 className="font-bold text-white text-lg mb-3">Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„:</h4>
                                                                <div className="flex gap-3">
                                                                    <div className="w-8 h-8 bg-brand-primary rounded-full flex items-center justify-center shrink-0 font-bold">1</div>
                                                                    <p>Ø­ÙˆÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù„Ù‰ Ø±Ù‚Ù… ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ Ø§Ù„Ù…ÙˆØ¶Ø­ Ø£Ø¹Ù„Ø§Ù‡</p>
                                                                </div>
                                                                <div className="flex gap-3">
                                                                    <div className="w-8 h-8 bg-brand-primary rounded-full flex items-center justify-center shrink-0 font-bold">2</div>
                                                                    <p>Ø®Ø¯ Ø³ÙƒØ±ÙŠÙ† Ø´ÙˆØª Ù„Ù„ØªØ­ÙˆÙŠÙ„ (Ù…Ù…ÙƒÙ† Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ My Vodafone)</p>
                                                                </div>
                                                                <div className="flex gap-3">
                                                                    <div className="w-8 h-8 bg-brand-primary rounded-full flex items-center justify-center shrink-0 font-bold">3</div>
                                                                    <p>Ø§Ø¨Ø¹Øª Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§ÙƒØªØ¨ Ù…Ø¹Ø§Ù‡Ø§ ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙØ¹</p>
                                                                </div>
                                                            </div>

                                                            {/* WhatsApp Button */}
                                                            <a href={`${CONTACT_INFO.whatsapp}?text=ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ - ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙØ¹: ${generatePaymentCode()} - ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨: ${user.code}`} 
                                                               target="_blank" 
                                                               className="flex items-center justify-center gap-3 w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold transition">
                                                                <SafeIcon name="message-circle" size={24}/>
                                                                Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø¹Ù„Ù‰ WhatsApp
                                                            </a>

                                                            <div className="bg-blue-500/10 border border-blue-500/30 p-4 rounded-xl">
                                                                <div className="flex gap-3">
                                                                    <SafeIcon name="info" className="text-blue-400 shrink-0"/>
                                                                    <div className="text-sm text-blue-200">
                                                                        <p className="font-bold mb-1">Ù…Ù„Ø­ÙˆØ¸Ø© Ù…Ù‡Ù…Ø©:</p>
                                                                        <p>Ø¨Ø¹Ø¯ Ù…Ø§ ØªØ¨Ø¹Øª Ø§Ù„Ø¥Ø«Ø¨Ø§Øª Ù‡ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø®Ù„Ø§Ù„ Ø¯Ù‚Ø§Ø¦Ù‚. Ù„Ùˆ ÙÙŠ Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø© ÙƒÙ„Ù… Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Free Content Tab */}
                                            {activeTab === 'free' && (
                                                <div className="animate-slide-up">
                                                    <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                                                        <SafeIcon name="gift" className="text-brand-accent"/> Ù…Ø­ØªÙˆÙ‰ Ù…Ø¬Ø§Ù†ÙŠ
                                                    </h2>
                                                    
                                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                                        {dataState.freeContent.length === 0 ? (
                                                            <div className="col-span-full text-center py-12 glass-panel">
                                                                <SafeIcon name="package" size={48} className="mx-auto text-gray-400 mb-3"/>
                                                                <p className="text-slate-500 font-bold">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù…Ø¬Ø§Ù†ÙŠ Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                                                            </div>
                                                        ) : (
                                                            dataState.freeContent.map(item => (
                                                                <div key={item.id} onClick={()=>{setSelectedLecture(item); setShowFreeContent(true);}} 
                                                                     className="glass-panel overflow-hidden cursor-pointer group hover:border-brand-accent/50 transition duration-300">
                                                                    <div className="h-44 bg-gradient-to-br from-blue-900/30 to-purple-900/30 relative flex items-center justify-center">
                                                                        <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                                                                        <SafeIcon name={item.type === 'video' ? 'play-circle' : 'file-text'} size={56} className="text-white/80 relative z-10 group-hover:scale-110 group-hover:text-brand-accent transition"/>
                                                                        <div className="absolute top-3 left-3 bg-brand-accent text-brand-dark px-2 py-1 rounded text-xs font-bold">
                                                                            {item.grade === '1sec' ? 'Ø£ÙˆÙ„' : item.grade === '2sec' ? 'Ø«Ø§Ù†ÙŠ' : 'Ø«Ø§Ù„Ø«'} Ø«Ø§Ù†ÙˆÙŠ
                                                                        </div>
                                                                    </div>
                                                                    <div className="p-5">
                                                                        <h3 className="font-bold text-lg mb-2 truncate">{item.title}</h3>
                                                                        <p className="text-xs text-slate-400 line-clamp-2">{item.description}</p>
                                                                        <div className="flex items-center gap-2 mt-3 text-xs text-slate-500">
                                                                            <SafeIcon name="clock" size={12}/>
                                                                            <span>{item.duration || '--'}</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ))
                                                        )}
                                                    </div>
                                                </div>
                                            )}

                                            {/* Lectures Tab */}
                                            {activeTab === 'lectures' && !selectedLecture && (
                                                <div className="animate-slide-up">
                                                    <div className="flex items-center justify-between mb-6">
                                                        <h2 className="text-2xl font-bold flex items-center gap-2">
                                                            <SafeIcon name="play-circle" className="text-brand-accent"/> Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª
                                                        </h2>
                                                        <div className="flex gap-2 bg-white/5 p-1 rounded-lg">
                                                            <button onClick={()=>setActiveGrade('all')} className={`px-3 py-1 rounded text-sm ${activeGrade === 'all' ? 'bg-brand-accent text-brand-dark' : 'hover:bg-white/10'}`}>Ø§Ù„ÙƒÙ„</button>
                                                            <button onClick={()=>setActiveGrade('1sec')} className={`px-3 py-1 rounded text-sm ${activeGrade === '1sec' ? 'bg-blue-500 text-white' : 'hover:bg-white/10'}`}>Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ</button>
                                                            <button onClick={()=>setActiveGrade('2sec')} className={`px-3 py-1 rounded text-sm ${activeGrade === '2sec' ? 'bg-purple-500 text-white' : 'hover:bg-white/10'}`}>Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ</button>
                                                            <button onClick={()=>setActiveGrade('3sec')} className={`px-3 py-1 rounded text-sm ${activeGrade === '3sec' ? 'bg-green-500 text-white' : 'hover:bg-white/10'}`}>Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ</button>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                                        {filteredLectures.filter(lec => activeGrade === 'all' || lec.grade === activeGrade).length === 0 ? (
                                                            <div className="col-span-full text-center py-12 glass-panel">
                                                                <SafeIcon name="video-off" size={48} className="mx-auto text-gray-400 mb-3"/>
                                                                <p className="text-slate-500 font-bold">Ù…ÙÙŠØ´ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                                                            </div>
                                                        ) : (
                                                            filteredLectures.filter(lec => activeGrade === 'all' || lec.grade === activeGrade).map(lec => (
                                                                <div key={lec.id} onClick={()=>{
                                                                    if (!user.isPaid) {
                                                                        return showNotification('Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙÙ‚Ø·. Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†!', 'error');
                                                                    }
                                                                    setSelectedLecture(lec); 
                                                                    setCurrentLectureStep('video'); 
                                                                    setQuizSubmitted(false); 
                                                                    setQuizAnswers({});
                                                                }} 
                                                                     className="glass-panel overflow-hidden cursor-pointer group hover:border-brand-accent/50 transition duration-300">
                                                                    <div className="h-44 bg-slate-900 relative flex items-center justify-center">
                                                                        <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                                                                        <SafeIcon name={user.isPaid ? "play-circle" : "lock"} size={56} className="text-white/80 relative z-10 group-hover:scale-110 group-hover:text-brand-accent transition"/>
                                                                        {!user.isPaid && (
                                                                            <div className="absolute inset-0 bg-black/70 flex items-center justify-center">
                                                                                <div className="bg-black/80 p-3 rounded-lg">
                                                                                    <SafeIcon name="lock" size={32} className="text-brand-accent"/>
                                                                                </div>
                                                                            </div>
                                                                        )}
                                                                        {lec.grade && (
                                                                            <div className="absolute top-3 left-3 bg-brand-primary/80 text-white px-2 py-1 rounded text-xs font-bold">
                                                                                {lec.grade === '1sec' ? 'Ø£ÙˆÙ„' : lec.grade === '2sec' ? 'Ø«Ø§Ù†ÙŠ' : 'Ø«Ø§Ù„Ø«'} Ø«Ø§Ù†ÙˆÙŠ
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                    <div className="p-5">
                                                                        <h3 className="font-bold text-lg mb-2 truncate">{lec.title}</h3>
                                                                        <p className="text-xs text-slate-400 line-clamp-2">{lec.description}</p>
                                                                        <div className="flex items-center justify-between mt-3">
                                                                            <span className="text-xs text-slate-500">{lec.date}</span>
                                                                            {!user.isPaid && <span className="text-xs text-red-400">ğŸ”’ Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</span>}
                                                                            {lec.completed && <span className="text-xs text-green-500">âœ“ Ù…ÙƒØªÙ…Ù„</span>}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ))
                                                        )}
                                                    </div>
                                                </div>
                                            )}

                                            {/* Single Lecture View */}
                                            {selectedLecture && user.isPaid && (
                                                <div className="animate-slide-up">
                                                    <button onClick={()=>setSelectedLecture(null)} 
                                                            className="mb-4 flex items-center gap-2 text-slate-400 hover:text-white font-bold transition">
                                                        <SafeIcon name="arrow-right"/> Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª
                                                    </button>

                                                    {/* Progress Steps */}
                                                    <div className="flex items-center justify-center gap-2 mb-6 flex-wrap">
                                                        {[
                                                            {id: 'video', label: 'Ø§Ù„ÙÙŠØ¯ÙŠÙˆ', icon: 'play-circle'},
                                                            {id: 'whiteboard', label: 'Ø§Ù„ØµØ¨ÙˆØ±Ø©', icon: 'image'},
                                                            {id: 'summary', label: 'Ø§Ù„Ù…Ù„Ø®Øµ', icon: 'book-open'},
                                                            {id: 'exam', label: 'Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†', icon: 'file-text'}
                                                        ].map((step, idx) => (
                                                            <div key={step.id} className="flex items-center">
                                                                <button 
                                                                    onClick={()=>setCurrentLectureStep(step.id)}
                                                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition ${currentLectureStep === step.id ? 'bg-brand-accent text-brand-dark' : 'bg-white/5 text-slate-400 hover:bg-white/10'}`}>
                                                                    <SafeIcon name={step.icon} size={16}/>
                                                                    {step.label}
                                                                </button>
                                                                {idx < 3 && <SafeIcon name="chevron-left" size={16} className="text-slate-600 mx-1"/>}
                                                            </div>
                                                        ))}
                                                    </div>

                                                    {/* Video Step */}
                                                    {currentLectureStep === 'video' && (
                                                        <div className="glass-panel overflow-hidden p-0 mb-8">
                                                            {renderContent(selectedLecture.link, 'video')}
                                                            <div className="p-6">
                                                                <div className="flex justify-between items-start mb-4">
                                                                    <div>
                                                                        <h2 className="text-2xl font-bold text-white mb-2">{selectedLecture.title}</h2>
                                                                        <div className="flex items-center gap-3 text-sm text-slate-400">
                                                                            {selectedLecture.grade && (
                                                                                <span className="bg-brand-primary/20 px-2 py-1 rounded">
                                                                                    {selectedLecture.grade === '1sec' ? 'Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ' : selectedLecture.grade === '2sec' ? 'Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ' : 'Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ'}
                                                                                </span>
                                                                            )}
                                                                            <span>{selectedLecture.date}</span>
                                                                        </div>
                                                                    </div>
                                                                    {selectedLecture.completed && (
                                                                        <span className="bg-green-500/20 text-green-300 px-3 py-1 rounded-full text-sm">
                                                                            âœ“ Ù…ÙƒØªÙ…Ù„
                                                                        </span>
                                                                    )}
                                                                </div>
                                                                <p className="text-slate-300 whitespace-pre-wrap mb-6">{selectedLecture.description}</p>
                                                                <button onClick={()=>setCurrentLectureStep('whiteboard')} 
                                                                        className="btn-main px-8 py-3 rounded-xl flex items-center gap-2 mx-auto">
                                                                    Ø§Ù„ØªØ§Ù„ÙŠ: Ø´ÙˆÙ Ø§Ù„ØµØ¨ÙˆØ±Ø© <SafeIcon name="arrow-left"/>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    )}

                                                    {/* Whiteboard Step */}
                                                    {currentLectureStep === 'whiteboard' && (
                                                        <div className="space-y-4">
                                                            <div className="glass-panel p-6">
                                                                <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                                                                    <SafeIcon name="image" className="text-brand-accent"/> ØµØ¨ÙˆØ±Ø© Ø§Ù„Ø­ØµØ©
                                                                </h3>
                                                                {dataState.whiteboards.filter(w => w.lectureId === selectedLecture.id).length === 0 ? (
                                                                    <p className="text-slate-500 text-center py-8">Ù…ÙÙŠØ´ ØµØ¨ÙˆØ±Ø© Ù„Ù„Ø­ØµØ© Ø¯ÙŠ</p>
                                                                ) : (
                                                                    <div className="grid grid-cols-1 gap-4">
                                                                        {dataState.whiteboards.filter(w => w.lectureId === selectedLecture.id).map(wb => (
                                                                            <div key={wb.id}>
                                                                                <h4 className="font-bold mb-2">{wb.title}</h4>
                                                                                {renderContent(wb.link, 'image')}
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                            </div>
                                                            <button onClick={()=>setCurrentLectureStep('summary')} 
                                                                    className="btn-main px-8 py-3 rounded-xl flex items-center gap-2 mx-auto">
                                                                Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ù‚Ø±Ø£ Ø§Ù„Ù…Ù„Ø®Øµ <SafeIcon name="arrow-left"/>
                                                            </button>
                                                        </div>
                                                    )}

                                                    {/* Summary Step */}
                                                    {currentLectureStep === 'summary' && (
                                                        <div className="space-y-4">
                                                            <div className="glass-panel p-6">
                                                                <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                                                                    <SafeIcon name="book-open" className="text-brand-accent"/> Ù…Ù„Ø®Øµ Ø§Ù„Ø­ØµØ©
                                                                </h3>
                                                                <div className="bg-white/5 p-6 rounded-xl border border-white/10">
                                                                    <p className="text-slate-300 leading-relaxed whitespace-pre-wrap">
                                                                        {selectedLecture.summary || 'Ø§Ù„Ù…Ù„Ø®Øµ: ÙÙŠ Ø§Ù„Ø­ØµØ© Ø¯ÙŠ Ø§ØªÙƒÙ„Ù…Ù†Ø§ Ø¹Ù† Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§ØªØ¹Ù„Ù…Ù†Ø§ Ø¥Ø²Ø§ÙŠ Ù†Ø­Ù„ Ø§Ù„Ù…Ø³Ø§Ø¦Ù„ Ø¨Ø·Ø±ÙŠÙ‚Ø© ØµØ­. Ø±Ø§Ø¬Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„ØµØ¨ÙˆØ±Ø© ÙƒÙˆÙŠØ³ ÙˆØ­Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†.'}
                                                                    </p>
                                                                </div>
                                                                {selectedLecture.keyPoints && (
                                                                    <div className="mt-4 bg-brand-accent/10 p-4 rounded-xl border border-brand-accent/30">
                                                                        <h4 className="font-bold text-brand-accent mb-2">Ø£Ù‡Ù… Ø§Ù„Ù†Ù‚Ø§Ø·:</h4>
                                                                        <ul className="space-y-1 text-sm text-slate-300">
                                                                            {selectedLecture.keyPoints.split('\n').map((point, idx) => (
                                                                                <li key={idx} className="flex gap-2">
                                                                                    <SafeIcon name="check" size={16} className="text-green-400 shrink-0 mt-0.5"/>
                                                                                    {point}
                                                                                </li>
                                                                            ))}
                                                                        </ul>
                                                                    </div>
                                                                )}
                                                            </div>
                                                            <button onClick={()=>setCurrentLectureStep('exam')} 
                                                                    className="btn-main px-8 py-3 rounded-xl flex items-center gap-2 mx-auto">
                                                                Ø§Ù„ØªØ§Ù„ÙŠ: Ø­Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† <SafeIcon name="arrow-left"/>
                                                            </button>
                                                        </div>
                                                    )}

                                                    {/* Exam Step */}
                                                    {currentLectureStep === 'exam' && (
                                                        <div className="glass-panel p-6">
                                                            <h3 className="text-xl font-bold mb-6 flex items-center gap-2">
                                                                <SafeIcon name="file-text" className="text-brand-accent"/> Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø­ØµØ©
                                                            </h3>

                                                            {dataState.exams.filter(e => e.lectureId === selectedLecture.id).length === 0 ? (
                                                                <p className="text-slate-500 text-center py-8">Ù…ÙÙŠØ´ Ø§Ù…ØªØ­Ø§Ù† Ù„Ù„Ø­ØµØ© Ø¯ÙŠ</p>
                                                            ) : (
                                                                <div className="space-y-6">
                                                                    {dataState.exams.filter(e => e.lectureId === selectedLecture.id).map(exam => (
                                                                        <div key={exam.id}>
                                                                            {exam.questions && exam.questions.map((q, idx) => (
                                                                                <div key={idx} className="mb-6 bg-white/5 p-5 rounded-xl border border-white/10">
                                                                                    <p className="font-bold mb-4 flex gap-2">
                                                                                        <span className="bg-brand-accent text-brand-dark px-2 py-1 rounded">Ø³{idx + 1}</span>
                                                                                        {q.question}
                                                                                    </p>

                                                                                    {q.type === 'mcq' ? (
                                                                                        <div className="space-y-2">
                                                                                            {q.options.map((opt, optIdx) => (
                                                                                                <button 
                                                                                                    key={optIdx}
                                                                                                    onClick={()=>setQuizAnswers({...quizAnswers, [idx]: optIdx})}
                                                                                                    disabled={quizSubmitted}
                                                                                                    className={`quiz-option w-full text-right p-3 rounded-lg border ${quizAnswers[idx] === optIdx ? 'selected' : 'border-white/10'} ${quizSubmitted && optIdx === q.correct ? 'bg-green-500/20 border-green-500' : quizSubmitted && quizAnswers[idx] === optIdx ? 'bg-red-500/20 border-red-500' : ''}`}>
                                                                                                    {opt}
                                                                                                </button>
                                                                                            ))}
                                                                                        </div>
                                                                                    ) : q.type === 'text' ? (
                                                                                        <textarea 
                                                                                            className="w-full bg-black/30 border border-white/10 rounded-lg p-3 outline-none text-white"
                                                                                            rows="3"
                                                                                            placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§..."
                                                                                            disabled={quizSubmitted}
                                                                                            value={quizAnswers[idx] || ''}
                                                                                            onChange={(e)=>setQuizAnswers({...quizAnswers, [idx]: e.target.value})}
                                                                                        />
                                                                                    ) : q.type === 'image' ? (
                                                                                        <div className="bg-blue-500/10 border border-blue-500/30 p-4 rounded-lg">
                                                                                            <p className="text-sm text-blue-200 mb-3">Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø­Ù„ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ±:</p>
                                                                                            <a href={`${exam.whatsappNumber || CONTACT_INFO.masterWhatsapp}?text=Ø­Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ ${idx + 1} Ù…Ù† Ø§Ù…ØªØ­Ø§Ù†: ${selectedLecture.title} - ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨: ${user.code}`} 
                                                                                               target="_blank"
                                                                                               className="flex items-center justify-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                                                                                                <SafeIcon name="message-circle"/> Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù„Ù‰ WhatsApp
                                                                                            </a>
                                                                                            <p className="text-xs text-slate-400 mt-2">Ø§ÙƒØªØ¨ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: "ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨: {user.code}"</p>
                                                                                        </div>
                                                                                    ) : null}
                                                                                </div>
                                                                            ))}

                                                                            {!quizSubmitted && (
                                                                                <button 
                                                                                    onClick={()=>{
                                                                                        setQuizSubmitted(true);
                                                                                        showNotification('ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ØŒ Ø³ÙŠØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­ Ù‚Ø±ÙŠØ¨Ø§Ù‹');
                                                                                    }} 
                                                                                    className="btn-main w-full py-3 rounded-xl font-bold">
                                                                                    ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
                                                                                </button>
                                                                            )}

                                                                            {quizSubmitted && (
                                                                                <div className="bg-green-500/10 border border-green-500/30 p-4 rounded-xl text-center">
                                                                                    <SafeIcon name="check-circle" size={48} className="text-green-500 mx-auto mb-2"/>
                                                                                    <p className="font-bold text-green-400">ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­!</p>
                                                                                    <p className="text-sm text-slate-400 mt-2">Ø³ÙŠØªÙ… ØªØµØ­ÙŠØ­Ù‡ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ùƒ</p>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {/* Q&A Tab */}
                                            {activeTab === 'qa' && (
                                                <div className="max-w-2xl mx-auto space-y-4 animate-slide-up">
                                                    <div className="glass-panel p-4 flex gap-2">
                                                        <input id="qInput" 
                                                               className="flex-1 bg-transparent outline-none text-white placeholder-slate-500" 
                                                               placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..."/>
                                                        <button onClick={async()=>{
                                                            const q = document.getElementById('qInput').value;
                                                            if(q){
                                                                await window.rtdb.push(window.rtdb.ref(window.db, 'qa'), {
                                                                    studentName: `${user.firstName} ${user.secondName}`, 
                                                                    studentId: user.uid, 
                                                                    question: q, 
                                                                    studentCode: user.code,
                                                                    date: new Date().toLocaleDateString('ar-EG'), 
                                                                    ts: Date.now()
                                                                });
                                                                document.getElementById('qInput').value = '';
                                                                showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„');
                                                            }
                                                        }} className="text-brand-accent hover:bg-white/5 p-2 rounded-lg">
                                                            <SafeIcon name="send"/>
                                                        </button>
                                                    </div>

                                                    <div className="space-y-4">
                                                        {dataState.qa.filter(q => q.studentId === user.uid).slice().reverse().map(q => (
                                                            <div key={q.id} className="glass-panel p-5">
                                                                <div className="flex items-center gap-3 mb-3">
                                                                    <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold">
                                                                        {q.studentName[0]}
                                                                    </div>
                                                                    <div>
                                                                        <p className="font-bold text-sm">{q.studentName}</p>
                                                                        <p className="text-xs text-slate-500">{q.date}</p>
                                                                    </div>
                                                                </div>
                                                                <p className="text-slate-200 bg-black/20 p-3 rounded-lg mb-3">{q.question}</p>
                                                                {q.reply && (
                                                                    <div className="flex gap-3 ml-4 bg-brand-primary/10 p-3 rounded-lg border-r-2 border-brand-primary">
                                                                        <div className="shrink-0"><SafeIcon name="corner-down-left" className="text-brand-primary"/></div>
                                                                        <div>
                                                                            <p className="text-xs font-bold text-brand-primary mb-1">Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ±:</p>
                                                                            <p className="text-sm text-slate-300">{q.reply}</p>
                                                                            <p className="text-xs text-slate-500 mt-1">{q.replyDate || ''}</p>
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </>
                                    )}
                                </main>
                            </div>

                            {/* Free Content Modal */}
                            {showFreeContent && selectedLecture && (
                                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4" onClick={()=>setShowFreeContent(false)}>
                                    <div className="bg-brand-card p-6 rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="text-2xl font-bold text-brand-accent">{selectedLecture.title}</h3>
                                            <button onClick={()=>setShowFreeContent(false)} className="text-slate-400 hover:text-white">
                                                <SafeIcon name="x" size={24}/>
                                            </button>
                                        </div>
                                        
                                        {renderContent(selectedLecture.link, selectedLecture.type || 'video')}
                                        
                                        <div className="mt-6">
                                            <p className="text-slate-300 mb-6">{selectedLecture.description}</p>
                                            
                                            <div className="bg-blue-500/10 border border-blue-500/30 p-4 rounded-xl">
                                                <h4 className="font-bold text-blue-300 mb-2">ğŸ’¡ Ù‡Ù„ Ø£Ø¹Ø¬Ø¨Ùƒ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØŸ</h4>
                                                <p className="text-sm text-slate-400 mb-3">
                                                    Ù‡Ø°Ø§ Ø¬Ø²Ø¡ Ø¨Ø³ÙŠØ· Ù…Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ØªØ§Ø­ Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†. Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù† Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰:
                                                </p>
                                                <ul className="space-y-1 text-sm text-slate-300">
                                                    <li className="flex items-center gap-2">âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©</li>
                                                    <li className="flex items-center gap-2">âœ… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</li>
                                                    <li className="flex items-center gap-2">âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…</li>
                                                    <li className="flex items-center gap-2">âœ… Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ø¹ØªÙ…Ø¯Ø©</li>
                                                </ul>
                                                <button onClick={()=>{setShowFreeContent(false); setActiveTab('subscription');}} 
                                                        className="btn-main w-full mt-4 py-3">
                                                    Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù† ÙˆØ§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                }

                // ğŸ‘‘ Admin View - Ù…Ø­Ø¯Ø«
                if (view === 'admin') {
                    const filteredStudents = dataState.students.filter(s => 
                        s.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        s.code?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        s.phone?.includes(searchQuery)
                    );

                    return (
                        <div className="min-h-screen bg-brand-dark p-6">
                            <div className="max-w-7xl mx-auto glass-panel p-8">
                                <div className="flex flex-wrap justify-between items-center mb-8 pb-4 border-b border-white/10 gap-4">
                                    <div>
                                        <h2 className="text-3xl font-black text-brand-accent">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h2>
                                        <p className="text-slate-400 text-sm">Ø£Ù‡Ù„Ø§Ù‹ ÙŠØ§ {user.role === 'boss' ? 'Ù…Ø¯ÙŠØ±' : 'Ø£Ø¯Ù…Ù†'} ğŸ‘‹</p>
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={sendWhatsAppToAll} 
                                                className="px-4 py-2 bg-green-600 rounded-lg font-bold hover:bg-green-700 flex items-center gap-2">
                                            <SafeIcon name="message-circle" size={18}/>
                                            Ø¥Ø±Ø³Ø§Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨
                                        </button>
                                        <button onClick={()=>setShowAssessmentModal(true)} 
                                                className="px-4 py-2 bg-blue-600 rounded-lg font-bold hover:bg-blue-700">
                                            ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø·Ù„Ø§Ø¨
                                        </button>
                                        <button onClick={()=>window.authMethods.signOut(window.auth)} 
                                                className="px-4 py-2 bg-red-600 rounded-lg font-bold hover:bg-red-700">
                                            Ø®Ø±ÙˆØ¬
                                        </button>
                                    </div>
                                </div>

                                {/* Stats */}
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                                    <div className="bg-white/5 p-4 rounded-xl border border-white/5">
                                        <div className="text-slate-400 text-xs mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                                        <div className="text-2xl font-black">{dataState.students.length}</div>
                                    </div>
                                    <div className="bg-white/5 p-4 rounded-xl border border-white/5">
                                        <div className="text-slate-400 text-xs mb-1">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
                                        <div className="text-2xl font-black text-orange-400">{dataState.requests.length}</div>
                                    </div>
                                    <div className="bg-white/5 p-4 rounded-xl border border-white/5">
                                        <div className="text-slate-400 text-xs mb-1">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</div>
                                        <div className="text-2xl font-black text-green-400">{dataState.payments.filter(p => p.status === 'pending').length}</div>
                                    </div>
                                    <div className="bg-white/5 p-4 rounded-xl border border-white/5">
                                        <div className="text-slate-400 text-xs mb-1">Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</div>
                                        <div className="text-2xl font-black text-brand-accent">{dataState.lectures.length}</div>
                                    </div>
                                </div>

                                {/* Tabs */}
                                <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                                    {['students', 'lectures', 'whiteboards', 'exams', 'freeContent', 'payments', 'qa', 'announcements', 'attendance'].map(t => (
                                        <button key={t} onClick={()=>setActiveTab(t)} 
                                                className={`px-6 py-2 rounded-lg font-bold whitespace-nowrap transition ${activeTab === t ? 'bg-brand-accent text-brand-dark' : 'bg-white/5 text-slate-400 hover:bg-white/10'}`}>
                                            {t === 'students' ? 'Ø§Ù„Ø·Ù„Ø§Ø¨' : 
                                             t === 'lectures' ? 'Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª' : 
                                             t === 'whiteboards' ? 'Ø§Ù„ØµØ¨ÙˆØ±Ø§Øª' : 
                                             t === 'exams' ? 'Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª' :
                                             t === 'freeContent' ? 'Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ' :
                                             t === 'payments' ? 'Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª' :
                                             t === 'qa' ? 'Ø§Ù„Ø£Ø³Ø¦Ù„Ø©' : 
                                             t === 'attendance' ? 'Ø§Ù„Ø­Ø¶ÙˆØ±' : 'Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª'}
                                        </button>
                                    ))}
                                </div>

                                {/* Content */}
                                <div className="bg-brand-dark/50 p-6 rounded-2xl border border-white/5 min-h-[400px]">
                                    
                                    {/* Students Tab */}
                                    {activeTab === 'students' && (
                                        <div>
                                            {/* Pending Requests */}
                                            {dataState.requests.length > 0 && (
                                                <div className="mb-8 bg-orange-500/10 border border-orange-500/30 p-4 rounded-xl">
                                                    <h3 className="font-bold text-orange-400 mb-3 flex items-center gap-2">
                                                        <SafeIcon name="user-plus"/> Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ({dataState.requests.length})
                                                    </h3>
                                                    <div className="space-y-2">
                                                        {dataState.requests.map(r => (
                                                            <div key={r.id} className="flex flex-col md:flex-row justify-between items-start md:items-center bg-black/20 p-3 rounded-lg gap-3">
                                                                <div className="flex gap-3 items-center">
                                                                    <img src={r.photo} className="w-10 h-10 rounded-full"/>
                                                                    <div>
                                                                        <p className="font-bold">{r.name}</p>
                                                                        <p className="text-xs text-slate-400">ğŸ“± {r.phone} | ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ {r.parentPhone}</p>
                                                                        <p className="text-xs text-slate-400">ğŸ« {r.school} | ğŸ“ {r.governorate}, {r.city}</p>
                                                                        <p className="text-xs text-slate-400">ğŸ“ {r.grade === '1sec' ? 'Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ' : r.grade === '2sec' ? 'Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ' : 'Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ'}</p>
                                                                        <p className="text-xs text-slate-400">ğŸ“… Ø£ÙŠØ§Ù… Ø§Ù„Ø­ØµØµ: {r.scheduleDays}</p>
                                                                    </div>
                                                                </div>
                                                                <div className="flex gap-2">
                                                                    <button onClick={async()=>{
                                                                        const studentCode = generateStudentCode();
                                                                        const studentData = {
                                                                            ...r,
                                                                            firstName: r.firstName,
                                                                            secondName: r.secondName,
                                                                            thirdName: r.thirdName,
                                                                            role: 'student',
                                                                            code: studentCode,
                                                                            isPaid: false,
                                                                            absences: 0,
                                                                            status: 'active'
                                                                        };
                                                                        
                                                                        // Save student to users
                                                                        await window.rtdb.set(window.rtdb.ref(window.db,'users/'+r.uid), studentData);
                                                                        
                                                                        // Remove from requests
                                                                        await window.rtdb.set(window.rtdb.ref(window.db,'requests/'+r.id), null);
                                                                        
                                                                        // Send WhatsApp message to student
                                                                        sendWhatsAppToStudent(studentData);
                                                                        
                                                                        showNotification(`ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯: ${studentCode}`);
                                                                    }} className="bg-green-600 px-3 py-1 rounded text-sm hover:bg-green-700">Ù‚Ø¨ÙˆÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯</button>
                                                                    <button onClick={()=>window.rtdb.set(window.rtdb.ref(window.db,'requests/'+r.id), null)} 
                                                                            className="bg-red-600 px-3 py-1 rounded text-sm hover:bg-red-700">Ø±ÙØ¶</button>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            {/* Search */}
                                            <div className="flex gap-2 mb-4">
                                                <input className="flex-1 bg-black/30 border border-white/10 p-3 rounded-xl outline-none" 
                                                       placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ØŒ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..." 
                                                       value={searchQuery} 
                                                       onChange={e=>setSearchQuery(e.target.value)}/>
                                                <button onClick={()=>setSearchQuery('')} className="px-4 bg-white/10 rounded-xl">Ù…Ø³Ø­</button>
                                            </div>

                                            {/* Students List */}
                                            <div className="space-y-2 max-h-[500px] overflow-y-auto">
                                                {filteredStudents.map(s => {
                                                    const daysLeft = calculateSubscriptionDays(dataState.subscriptions[s.id]?.endDate);
                                                    const attendanceCount = Object.keys(dataState.attendance[s.id] || {}).length;
                                                    const attendanceRank = calculateRank('attendance', attendanceCount);
                                                    
                                                    return (
                                                        <div key={s.id} className="flex flex-col md:flex-row justify-between items-start md:items-center bg-white/5 p-4 rounded-xl hover:bg-white/10 transition gap-3">
                                                            <div className="flex items-center gap-4 flex-1">
                                                                <div className="relative">
                                                                    <img src={s.photo} className="w-12 h-12 rounded-full"/>
                                                                    <div className={`absolute bottom-0 right-0 w-3 h-3 rounded-full ${s.isPaid?'bg-green-500':'bg-red-500'}`}></div>
                                                                </div>
                                                                <div>
                                                                    <p className="font-bold">{s.name}</p>
                                                                    <div className="flex gap-2 text-xs text-slate-400">
                                                                        <span className="font-mono bg-black/30 px-1 rounded">{s.code}</span>
                                                                        <span>|</span>
                                                                        <span>ğŸ“± {s.phone}</span>
                                                                        <span>|</span>
                                                                        <span>ğŸ“ {s.grade === '1sec' ? 'Ø£ÙˆÙ„' : s.grade === '2sec' ? 'Ø«Ø§Ù†ÙŠ' : 'Ø«Ø§Ù„Ø«'} Ø«Ø§Ù†ÙˆÙŠ</span>
                                                                        {s.isPaid && daysLeft > 0 && (
                                                                            <>
                                                                                <span>|</span>
                                                                                <span className="text-green-400">Ø¨Ø§Ù‚ÙŠ {daysLeft} ÙŠÙˆÙ…</span>
                                                                            </>
                                                                        )}
                                                                    </div>
                                                                    <div className="flex gap-2 mt-1">
                                                                        <div className="text-xs" style={{color: attendanceRank.color}}>
                                                                            <SafeIcon name="calendar-check" size={10} className="inline"/> {attendanceCount} ÙŠÙˆÙ…
                                                                        </div>
                                                                        {s.absences > 0 && (
                                                                            <div className="text-xs text-red-400">
                                                                                <SafeIcon name="x-circle" size={10} className="inline"/> {s.absences} ØºÙŠØ§Ø¨
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                    <div className="text-xs text-slate-500 mt-1">
                                                                        Ø£ÙŠØ§Ù… Ø§Ù„Ø­ØµØµ: {s.scheduleDays} | Ø§Ù„Ù…Ø±ÙƒØ²: {s.center}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div className="flex gap-2 flex-wrap">
                                                                <button onClick={()=>{setSelectedStudent(s); setShowStudentModal(true);}} 
                                                                        className="px-3 py-1 bg-blue-500/20 text-blue-400 rounded hover:bg-blue-500 hover:text-white transition text-sm">
                                                                    Ø¥Ø¯Ø§Ø±Ø©
                                                                </button>
                                                                <button onClick={()=>sendWhatsAppToStudent(s)}
                                                                        className="px-3 py-1 bg-green-500/20 text-green-400 rounded hover:bg-green-500 hover:text-white transition text-sm">
                                                                    <SafeIcon name="message-circle" size={12}/>
                                                                </button>
                                                                <button onClick={()=>{
                                                                    const newStatus = !s.isPaid;
                                                                    updateStudent(s.id, {isPaid: newStatus});
                                                                    showNotification(newStatus ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ' : 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ');
                                                                }} 
                                                                        className={`px-3 py-1 rounded text-sm ${s.isPaid ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                                                                    {s.isPaid ? 'âœ“ Ù…ÙØ¹Ù„' : 'âœ— Ø¥Ù„ØºØ§Ø¡'}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}

                                    {/* Lectures Tab */}
                                    {activeTab === 'lectures' && (
                                        <div className="space-y-6">
                                            <div className="bg-black/20 p-6 rounded-xl border border-white/10">
                                                <h3 className="font-bold mb-4 flex items-center gap-2">
                                                    <SafeIcon name="plus-circle" className="text-brand-accent"/> Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©
                                                </h3>
                                                <div className="space-y-3">
                                                    <input id="lecTitle" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© *"/>
                                                    <textarea id="lecDesc" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none h-20" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©"></textarea>
                                                    <div className="grid md:grid-cols-2 gap-3">
                                                        <select id="lecGrade" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none">
                                                            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
                                                            <option value="1sec">Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ</option>
                                                            <option value="2sec">Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ</option>
                                                            <option value="3sec">Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ</option>
                                                        </select>
                                                        <input id="lecDuration" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none" placeholder="Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"/>
                                                    </div>
                                                    <input id="lecLink" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (YouTube, Embed, Drive, Ø£ÙŠ Ø³ÙŠØ±ÙØ±) *"/>
                                                    <textarea id="lecSummary" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none h-24" placeholder="Ù…Ù„Ø®Øµ Ø§Ù„Ø­ØµØ©"></textarea>
                                                    <textarea id="lecKeyPoints" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none h-20" placeholder="Ø£Ù‡Ù… Ø§Ù„Ù†Ù‚Ø§Ø· (ÙƒÙ„ Ù†Ù‚Ø·Ø© ÙÙŠ Ø³Ø·Ø±)"></textarea>
                                                    <button onClick={()=>{
                                                        const title = document.getElementById('lecTitle').value;
                                                        const link = document.getElementById('lecLink').value;
                                                        if(!title || !link) {
                                                            return showNotification('Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø±Ø§Ø¨Ø· Ù…Ø·Ù„ÙˆØ¨Ø§Ù†', 'error');
                                                        }
                                                        uploadItem('lectures', {
                                                            title: title,
                                                            description: document.getElementById('lecDesc').value,
                                                            grade: document.getElementById('lecGrade').value,
                                                            duration: document.getElementById('lecDuration').value,
                                                            link: link,
                                                            summary: document.getElementById('lecSummary').value,
                                                            keyPoints: document.getElementById('lecKeyPoints').value
                                                        });
                                                        ['lecTitle', 'lecDesc', 'lecLink', 'lecSummary', 'lecKeyPoints', 'lecDuration'].forEach(id => document.getElementById(id).value = '');
                                                    }} className="btn-main w-full py-2 rounded-lg">Ù†Ø´Ø± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</button>
                                                </div>
                                            </div>
                                            
                                            <div className="space-y-2">
                                                {dataState.lectures.map(l => (
                                                    <div key={l.id} className="flex justify-between items-center bg-white/5 p-3 rounded-lg hover:bg-white/10">
                                                        <div className="flex items-center gap-3">
                                                            <span className="font-bold">{l.title}</span>
                                                            {l.grade && l.grade !== 'all' && (
                                                                <span className="text-xs bg-brand-primary/30 px-2 py-1 rounded">
                                                                    {l.grade === '1sec' ? 'Ø£ÙˆÙ„' : l.grade === '2sec' ? 'Ø«Ø§Ù†ÙŠ' : 'Ø«Ø§Ù„Ø«'} Ø«Ø§Ù†ÙˆÙŠ
                                                                </span>
                                                            )}
                                                        </div>
                                                        {user.role === 'boss' && (
                                                            <button onClick={()=>window.rtdb.remove(window.rtdb.ref(window.db, 'lectures/'+l.id))} 
                                                                    className="text-red-400 hover:bg-red-500/20 p-2 rounded">
                                                                <SafeIcon name="trash-2" size={18}/>
                                                            </button>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* Free Content Tab */}
                                    {activeTab === 'freeContent' && (
                                        <div className="space-y-6">
                                            <div className="bg-black/20 p-6 rounded-xl border border-white/10">
                                                <h3 className="font-bold mb-4 flex items-center gap-2">
                                                    <SafeIcon name="gift" className="text-brand-accent"/> Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰ Ù…Ø¬Ø§Ù†ÙŠ
                                                </h3>
                                                <div className="space-y-3">
                                                    <input id="freeTitle" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ *"/>
                                                    <textarea id="freeDesc" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none h-20" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ø­ØªÙˆÙ‰"></textarea>
                                                    <select id="freeGrade" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none">
                                                        <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
                                                        <option value="1sec">Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ</option>
                                                        <option value="2sec">Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ</option>
                                                        <option value="3sec">Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ</option>
                                                    </select>
                                                    <select id="freeType" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none">
                                                        <option value="video">ÙÙŠØ¯ÙŠÙˆ</option>
                                                        <option value="document">Ù…Ù„Ù</option>
                                                        <option value="quiz">Ø§Ø®ØªØ¨Ø§Ø±</option>
                                                    </select>
                                                    <input id="freeLink" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø­ØªÙˆÙ‰ *"/>
                                                    <input id="freeDuration" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none" placeholder="Ø§Ù„Ù…Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"/>
                                                    <button onClick={()=>{
                                                        const title = document.getElementById('freeTitle').value;
                                                        const link = document.getElementById('freeLink').value;
                                                        if(!title || !link) {
                                                            return showNotification('Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø±Ø§Ø¨Ø· Ù…Ø·Ù„ÙˆØ¨Ø§Ù†', 'error');
                                                        }
                                                        uploadItem('freeContent', {
                                                            title: title,
                                                            description: document.getElementById('freeDesc').value,
                                                            grade: document.getElementById('freeGrade').value,
                                                            type: document.getElementById('freeType').value,
                                                            link: link,
                                                            duration: document.getElementById('freeDuration').value
                                                        });
                                                        ['freeTitle', 'freeDesc', 'freeLink', 'freeDuration'].forEach(id => document.getElementById(id).value = '');
                                                    }} className="btn-main w-full py-2 rounded-lg">Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰ Ù…Ø¬Ø§Ù†ÙŠ</button>
                                                </div>
                                            </div>
                                            
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                {dataState.freeContent.map(item => (
                                                    <div key={item.id} className="bg-white/5 p-4 rounded-lg">
                                                        <div className="flex justify-between items-start">
                                                            <h4 className="font-bold">{item.title}</h4>
                                                            <span className="text-xs bg-brand-accent/30 px-2 py-1 rounded">
                                                                {item.type === 'video' ? 'ğŸ¬' : item.type === 'document' ? 'ğŸ“„' : 'ğŸ“'}
                                                            </span>
                                                        </div>
                                                        <p className="text-sm text-slate-400 mt-1">{item.description}</p>
                                                        <div className="flex justify-between items-center mt-2">
                                                            <span className="text-xs text-slate-500">
                                                                {item.grade === '1sec' ? 'Ø£ÙˆÙ„' : item.grade === '2sec' ? 'Ø«Ø§Ù†ÙŠ' : 'Ø«Ø§Ù„Ø«'} Ø«Ø§Ù†ÙˆÙŠ
                                                            </span>
                                                            <button onClick={()=>window.rtdb.remove(window.rtdb.ref(window.db, 'freeContent/'+item.id))} 
                                                                    className="text-red-400 hover:text-red-300 text-sm">
                                                                Ø­Ø°Ù
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* Whiteboards Tab */}
                                    {activeTab === 'whiteboards' && (
                                        <div className="space-y-6">
                                            <div className="bg-black/20 p-6 rounded-xl border border-white/10">
                                                <h3 className="font-bold mb-4">Ø±ÙØ¹ ØµØ¨ÙˆØ±Ø©</h3>
                                                <div className="space-y-3">
                                                    <select id="wbLecId" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none">
                                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©...</option>
                                                        {dataState.lectures.map(l => <option key={l.id} value={l.id}>{l.title}</option>)}
                                                    </select>
                                                    <input id="wbTitle" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none" placeholder="Ø§Ø³Ù… Ø§Ù„ØµØ¨ÙˆØ±Ø©"/>
                                                    <input id="wbLink" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (ImgBB)"/>
                                                    <button onClick={()=>{
                                                        uploadItem('whiteboards', {
                                                            lectureId: document.getElementById('wbLecId').value,
                                                            title: document.getElementById('wbTitle').value,
                                                            link: document.getElementById('wbLink').value
                                                        });
                                                        ['wbTitle', 'wbLink'].forEach(id => document.getElementById(id).value = '');
                                                    }} className="btn-main w-full py-2 rounded-lg">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµØ¨ÙˆØ±Ø©</button>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Exams Tab */}
                                    {activeTab === 'exams' && (
                                        <div className="space-y-6">
                                            <div className="bg-black/20 p-6 rounded-xl border border-white/10">
                                                <h3 className="font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ø§Ù…ØªØ­Ø§Ù†</h3>
                                                <div className="space-y-3">
                                                    <select id="examLecId" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none">
                                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©...</option>
                                                        {dataState.lectures.map(l => <option key={l.id} value={l.id}>{l.title}</option>)}
                                                    </select>
                                                    <input id="examWhatsapp" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none" placeholder="Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" value={CONTACT_INFO.masterWhatsapp}/>
                                                    
                                                    <div className="bg-white/5 p-4 rounded-lg">
                                                        <p className="text-sm mb-2 font-bold">Ø£Ø¶Ù Ø£Ø³Ø¦Ù„Ø© (JSON Format):</p>
                                                        <textarea id="examQuestions" className="w-full bg-black/30 border border-white/10 p-3 rounded-lg outline-none h-32 font-mono text-xs" placeholder='[{"question":"Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„ØŸ","type":"mcq","options":["Ø£","Ø¨","Ø¬","Ø¯"],"correct":0},{"question":"Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠ","type":"text"},{"question":"Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø«Ø§Ù„Ø« (ØµÙˆØ±Ø©)","type":"image"}]'></textarea>
                                                        <p className="text-xs text-slate-400 mt-2">Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©: mcq (Ø§Ø®ØªÙŠØ§Ø±ÙŠ), text (Ù…Ù‚Ø§Ù„ÙŠ), image (Ø±Ø³Ù…)</p>
                                                    </div>

                                                    <button onClick={()=>{
                                                        try {
                                                            const questions = JSON.parse(document.getElementById('examQuestions').value);
                                                            uploadItem('exams', {
                                                                lectureId: document.getElementById('examLecId').value,
                                                                whatsappNumber: document.getElementById('examWhatsapp').value,
                                                                questions: questions
                                                            });
                                                            ['examQuestions'].forEach(id => document.getElementById(id).value = '');
                                                        } catch(e) {
                                                            showNotification('Ø®Ø·Ø£ ÙÙŠ ØµÙŠØºØ© JSON', 'error');
                                                        }
                                                    }} className="btn-main w-full py-2 rounded-lg">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Payments Tab */}
                                    {activeTab === 'payments' && (
                                        <div>
                                            <h3 className="font-bold mb-4">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3>
                                            {dataState.payments.filter(p => p.status === 'pending').length === 0 ? (
                                                <p className="text-slate-500">Ù…ÙÙŠØ´ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</p>
                                            ) : (
                                                <div className="space-y-3">
                                                    {dataState.payments.filter(p => p.status === 'pending').map(p => (
                                                        <div key={p.id} className="bg-white/5 p-4 rounded-xl flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                                                            <div>
                                                                <p className="font-bold text-white">{p.studentName}</p>
                                                                <p className="text-xs text-slate-400">{p.date} | ÙƒÙˆØ¯: {p.code}</p>
                                                                {p.receiptImage && (
                                                                    <a href={p.receiptImage} target="_blank" className="text-brand-primary text-xs underline mt-1 block">
                                                                        Ø¹Ø±Ø¶ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹
                                                                    </a>
                                                                )}
                                                            </div>
                                                            <div className="flex gap-2">
                                                                <button onClick={async()=>{
                                                                    await window.rtdb.update(window.rtdb.ref(window.db,'users/'+p.studentId), {isPaid: true});
                                                                    await window.rtdb.update(window.rtdb.ref(window.db,'payments/'+p.id), {status: 'approved'});
                                                                    showNotification('ØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© âœ…');
                                                                }} className="bg-green-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-green-700">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                                                                <button onClick={()=>window.rtdb.update(window.rtdb.ref(window.db,'payments/'+p.id), {status: 'rejected'})} 
                                                                        className="bg-red-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-red-700">Ø±ÙØ¶</button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Attendance Tab */}
                                    {activeTab === 'attendance' && (
                                        <div>
                                            <h3 className="font-bold mb-4">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
                                            <div className="overflow-x-auto">
                                                <table className="w-full">
                                                    <thead>
                                                        <tr className="border-b border-white/10">
                                                            <th className="text-right p-3">Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                                            <th className="text-right p-3">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                                                            <th className="text-right p-3">Ø§Ù„ØºÙŠØ§Ø¨</th>
                                                            <th className="text-right p-3">Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                                                            <th className="text-right p-3">Ø§Ù„Ø±ØªØ¨Ø©</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {dataState.students.map(s => {
                                                            const attendanceCount = Object.keys(dataState.attendance[s.id] || {}).length;
                                                            const totalDays = 30; // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
                                                            const percentage = Math.round((attendanceCount / totalDays) * 100);
                                                            const attendanceRank = calculateRank('attendance', attendanceCount);
                                                            
                                                            return (
                                                                <tr key={s.id} className="border-b border-white/5 hover:bg-white/5">
                                                                    <td className="p-3">
                                                                        <div className="flex items-center gap-2">
                                                                            <img src={s.photo} className="w-8 h-8 rounded-full"/>
                                                                            <div>
                                                                                <p className="font-bold text-sm">{s.name}</p>
                                                                                <p className="text-xs text-slate-500">{s.code}</p>
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                    <td className="p-3 text-center font-bold">{attendanceCount}</td>
                                                                    <td className="p-3 text-center text-red-400">{s.absences || 0}</td>
                                                                    <td className="p-3 text-center">
                                                                        <div className="inline-flex items-center gap-2">
                                                                            <span className="font-bold">{percentage}%</span>
                                                                            <div className="w-20 h-2 bg-white/10 rounded-full overflow-hidden">
                                                                                <div className="h-full bg-green-500 rounded-full" style={{width: `${percentage}%`}}></div>
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                    <td className="p-3 text-center">
                                                                        <span className="text-xs px-2 py-1 rounded-full" style={{backgroundColor: `${attendanceRank.color}20`, color: attendanceRank.color}}>
                                                                            {attendanceRank.name}
                                                                        </span>
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}

                                    {/* Q&A Tab */}
                                    {activeTab === 'qa' && (
                                        <div className="space-y-3">
                                            {dataState.qa.map(q => (
                                                <div key={q.id} className="bg-white/5 p-4 rounded-xl">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div>
                                                            <p className="font-bold text-white mb-1">{q.studentName}</p>
                                                            <p className="text-xs text-slate-400">ÙƒÙˆØ¯: {q.studentCode} | {q.date}</p>
                                                        </div>
                                                        <span className="text-xs bg-brand-primary/30 px-2 py-1 rounded">
                                                            {q.reply ? 'âœ“ ØªÙ… Ø§Ù„Ø±Ø¯' : 'â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø¯'}
                                                        </span>
                                                    </div>
                                                    <p className="text-slate-300 mb-3 bg-black/20 p-3 rounded-lg">{q.question}</p>
                                                    {!q.reply && (
                                                        <div className="flex gap-2">
                                                            <button onClick={async()=>{
                                                                const r=prompt("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯:");
                                                                if(r) {
                                                                    await window.rtdb.update(window.rtdb.ref(window.db,`qa/${q.id}`),{
                                                                        reply: r,
                                                                        replyDate: new Date().toLocaleDateString('ar-EG'),
                                                                        repliedBy: user.role
                                                                    });
                                                                    showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯');
                                                                }
                                                            }} className="bg-blue-600 px-4 py-1 rounded text-sm">Ø±Ø¯</button>
                                                            <button onClick={async()=>{
                                                                await window.rtdb.remove(window.rtdb.ref(window.db,`qa/${q.id}`));
                                                                showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„');
                                                            }} className="bg-red-600 px-4 py-1 rounded text-sm">Ø­Ø°Ù</button>
                                                        </div>
                                                    )}
                                                    {q.reply && (
                                                        <div className="bg-green-500/10 p-3 rounded-lg mt-2">
                                                            <p className="text-xs font-bold text-green-400 mb-1">ØªÙ… Ø§Ù„Ø±Ø¯ Ø¨ÙˆØ§Ø³Ø·Ø© {q.repliedBy}:</p>
                                                            <p className="text-sm text-slate-300">{q.reply}</p>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {/* Announcements Tab */}
                                    {activeTab === 'announcements' && (
                                        <div className="space-y-6">
                                            <div className="bg-black/20 p-6 rounded-xl border border-white/10">
                                                <h3 className="font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù†</h3>
                                                <div className="space-y-3">
                                                    <input id="annTitle" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"/>
                                                    <textarea id="annContent" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none h-24" placeholder="Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"></textarea>
                                                    <select id="annType" className="w-full bg-white/5 border border-white/10 p-3 rounded-lg outline-none">
                                                        <option value="info">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</option>
                                                        <option value="alert">ØªÙ†Ø¨ÙŠÙ‡</option>
                                                        <option value="update">ØªØ­Ø¯ÙŠØ«</option>
                                                        <option value="event">ÙØ¹Ø§Ù„ÙŠØ©</option>
                                                    </select>
                                                    <button onClick={()=>{
                                                        uploadItem('announcements', {
                                                            title: document.getElementById('annTitle').value,
                                                            content: document.getElementById('annContent').value,
                                                            type: document.getElementById('annType').value
                                                        });
                                                        ['annTitle', 'annContent'].forEach(id => document.getElementById(id).value = '');
                                                    }} className="btn-main w-full py-2 rounded-lg">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Student Management Modal */}
                                {showStudentModal && selectedStudent && (
                                    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4" onClick={()=>setShowStudentModal(false)}>
                                        <div className="bg-brand-card p-6 rounded-2xl w-full max-w-lg border border-white/10 max-h-[90vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                                            <h3 className="text-xl font-bold mb-4 text-brand-accent">Ø¥Ø¯Ø§Ø±Ø©: {selectedStudent.name}</h3>
                                            
                                            <div className="space-y-4">
                                                {/* Student Info */}
                                                <div className="grid grid-cols-2 gap-4 text-sm">
                                                    <div>
                                                        <p className="text-slate-400 text-xs mb-1">Ø§Ù„ÙƒÙˆØ¯:</p>
                                                        <p className="font-bold">{selectedStudent.code}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-slate-400 text-xs mb-1">Ø§Ù„ØµÙ:</p>
                                                        <p className="font-bold">{selectedStudent.grade === '1sec' ? 'Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ' : selectedStudent.grade === '2sec' ? 'Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ' : 'Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ'}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-slate-400 text-xs mb-1">Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</p>
                                                        <p className="font-bold">{selectedStudent.phone}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-slate-400 text-xs mb-1">Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</p>
                                                        <p className="font-bold">{selectedStudent.parentPhone}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-slate-400 text-xs mb-1">Ø§Ù„Ù…Ø±ÙƒØ²:</p>
                                                        <p className="font-bold">{selectedStudent.center || '--'}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-slate-400 text-xs mb-1">Ø£ÙŠØ§Ù… Ø§Ù„Ø­ØµØµ:</p>
                                                        <p className="font-bold">{selectedStudent.scheduleDays}</p>
                                                    </div>
                                                </div>

                                                {/* Notes */}
                                                <div>
                                                    <label className="text-xs text-slate-400 mb-1 block">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                                                    <textarea 
                                                        className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white h-20" 
                                                        value={selectedStudent.notes || ''} 
                                                        onChange={e=>setSelectedStudent({...selectedStudent, notes: e.target.value})}
                                                    />
                                                </div>

                                                {/* Status Controls */}
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="text-xs text-slate-400 mb-1 block">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹:</label>
                                                        <button onClick={()=>{
                                                            const newState = !selectedStudent.isPaid;
                                                            updateStudent(selectedStudent.id, {isPaid: newState});
                                                            setSelectedStudent({...selectedStudent, isPaid: newState});
                                                        }} className={`w-full px-4 py-2 rounded-lg font-bold ${selectedStudent.isPaid ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-red-500/20 text-red-400 border border-red-500/30'}`}>
                                                            {selectedStudent.isPaid ? 'âœ“ Ù…ÙØ¹Ù„' : 'âœ— ØºÙŠØ± Ù…ÙØ¹Ù„'}
                                                        </button>
                                                    </div>
                                                    <div>
                                                        <label className="text-xs text-slate-400 mb-1 block">Ø§Ù„ØºÙŠØ§Ø¨:</label>
                                                        <input 
                                                            type="number"
                                                            className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-center"
                                                            value={selectedStudent.absences || 0}
                                                            onChange={e=>{
                                                                const value = parseInt(e.target.value) || 0;
                                                                setSelectedStudent({...selectedStudent, absences: value});
                                                            }}
                                                        />
                                                    </div>
                                                </div>

                                                {/* Add Subscription */}
                                                <div>
                                                    <label className="text-xs text-slate-400 mb-1 block">Ø¥Ø¶Ø§ÙØ©/ØªØ¬Ø¯ÙŠØ¯ Ø§Ø´ØªØ±Ø§Ùƒ:</label>
                                                    <div className="flex gap-2">
                                                        <select id="subMonths" className="flex-1 bg-black/30 border border-white/10 rounded-lg p-2">
                                                            <option value="1">Ø´Ù‡Ø± ÙˆØ§Ø­Ø¯</option>
                                                            <option value="2">Ø´Ù‡Ø±ÙŠÙ†</option>
                                                            <option value="3">3 Ø´Ù‡ÙˆØ±</option>
                                                            <option value="6">6 Ø´Ù‡ÙˆØ±</option>
                                                            <option value="12">Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©</option>
                                                        </select>
                                                        <button onClick={()=>{
                                                            const months = parseInt(document.getElementById('subMonths').value);
                                                            addSubscription(selectedStudent.id, months);
                                                            setSelectedStudent({
                                                                ...selectedStudent,
                                                                isPaid: true
                                                            });
                                                        }} className="bg-brand-accent text-brand-dark px-4 py-2 rounded-lg font-bold">Ø¥Ø¶Ø§ÙØ©</button>
                                                    </div>
                                                    {dataState.subscriptions[selectedStudent.id] && (
                                                        <p className="text-xs text-green-400 mt-2">
                                                            Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: Ø¨Ø§Ù‚ÙŠ {calculateSubscriptionDays(dataState.subscriptions[selectedStudent.id].endDate)} ÙŠÙˆÙ…
                                                        </p>
                                                    )}
                                                </div>

                                                <div className="flex gap-2 pt-4">
                                                    <button onClick={()=>{
                                                        updateStudent(selectedStudent.id, {
                                                            notes: selectedStudent.notes,
                                                            absences: selectedStudent.absences || 0
                                                        });
                                                        showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª');
                                                    }} className="flex-1 bg-brand-primary py-2 rounded-lg font-bold">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                                                    <button onClick={()=>setShowStudentModal(false)} className="px-4 py-2 bg-white/10 rounded-lg font-bold">Ø¥ØºÙ„Ø§Ù‚</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Weekly Assessment Modal */}
                                {showAssessmentModal && (
                                    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4" onClick={()=>setShowAssessmentModal(false)}>
                                        <div className="bg-brand-card p-6 rounded-2xl w-full max-w-2xl border border-white/10 max-h-[90vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                                            <h3 className="text-xl font-bold mb-4 text-brand-accent">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h3>
                                            
                                            <div className="space-y-4">
                                                <div className="bg-white/5 p-4 rounded-xl">
                                                    <h4 className="font-bold mb-3">Ø§Ø®ØªØ± Ø§Ù„Ø·Ù„Ø§Ø¨:</h4>
                                                    <div className="max-h-60 overflow-y-auto space-y-2">
                                                        {dataState.students.filter(s => s.isPaid).map(student => (
                                                            <div key={student.id} className="flex items-center justify-between p-2 hover:bg-white/5 rounded">
                                                                <div className="flex items-center gap-3">
                                                                    <input type="checkbox" id={`student-${student.id}`} className="rounded"/>
                                                                    <label htmlFor={`student-${student.id}`} className="flex items-center gap-2">
                                                                        <img src={student.photo} className="w-8 h-8 rounded-full"/>
                                                                        <div>
                                                                            <p className="font-bold text-sm">{student.name}</p>
                                                                            <p className="text-xs text-slate-500">{student.code}</p>
                                                                        </div>
                                                                    </label>
                                                                </div>
                                                                <span className="text-xs bg-green-500/20 text-green-300 px-2 py-1 rounded">
                                                                    {student.grade === '1sec' ? 'Ø£ÙˆÙ„' : student.grade === '2sec' ? 'Ø«Ø§Ù†ÙŠ' : 'Ø«Ø§Ù„Ø«'} Ø«Ø§Ù†ÙˆÙŠ
                                                                </span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>

                                                <div>
                                                    <label className="text-xs text-slate-400 mb-1 block">Ù†Øµ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</label>
                                                    <textarea 
                                                        id="assessmentText"
                                                        className="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white h-32"
                                                        placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù‡Ù†Ø§..."
                                                        defaultValue="Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø² Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªÙÙˆÙ‚ ÙˆØ­Ù„ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª. Ù†Ù†ØµØ­ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©."
                                                    ></textarea>
                                                </div>

                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="text-xs text-slate-400 mb-1 block">Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</label>
                                                        <select id="assessmentLevel" className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white">
                                                            <option value="excellent">Ù…Ù…ØªØ§Ø²</option>
                                                            <option value="very-good">Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</option>
                                                            <option value="good">Ø¬ÙŠØ¯</option>
                                                            <option value="needs-improvement">ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="text-xs text-slate-400 mb-1 block">Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</label>
                                                        <input 
                                                            type="number"
                                                            id="assessmentScore"
                                                            className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-center"
                                                            min="0"
                                                            max="100"
                                                            defaultValue="85"
                                                        />
                                                    </div>
                                                </div>

                                                <div className="flex gap-2 pt-4">
                                                    <button onClick={()=>{
                                                        const assessment = document.getElementById('assessmentText').value;
                                                        const level = document.getElementById('assessmentLevel').value;
                                                        const score = document.getElementById('assessmentScore').value;
                                                        
                                                        // Here you would send assessment to selected students
                                                        // This could be via WhatsApp or internal notification
                                                        
                                                        showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†');
                                                        setShowAssessmentModal(false);
                                                    }} className="flex-1 bg-green-600 py-2 rounded-lg font-bold">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
                                                    <button onClick={()=>setShowAssessmentModal(false)} className="px-4 py-2 bg-white/10 rounded-lg font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                }

                // Loading
                if (view === 'loading') return (
                    <div className="h-screen bg-brand-dark flex items-center justify-center text-brand-accent font-bold text-xl">
                        <div className="text-center">
                            <div className="loader mx-auto mb-4"></div>
                            <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>
                );

            } catch (error) {
                console.error('App Error:', error);
                // Default fallback to landing page
                setView('landing');
                return null;
            }

            return (
                <>
                    {notification && (
                        <div className={`fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl font-bold z-[100] text-white flex items-center gap-2 ${notification.type==='error'?'bg-red-600':'bg-green-600'}`}>
                            <SafeIcon name={notification.type==='error'?'alert-circle':'check-circle'}/>
                            {notification.message}
                        </div>
                    )}
                </>
            );
        };

        const RootApp = () => (
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RootApp />);
    </script>
</body>
</html>